(()=>{"use strict";var e,t,i={d:(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};i.r(n),i.d(n,{createAffirmPaymentStrategy:()=>_});class s extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}!function(e){e[e.MissingBillingAddress=0]="MissingBillingAddress",e[e.MissingCart=1]="MissingCart",e[e.MissingCheckout=2]="MissingCheckout",e[e.MissingConsignments=3]="MissingConsignments",e[e.MissingCustomer=4]="MissingCustomer",e[e.MissingCheckoutConfig=5]="MissingCheckoutConfig",e[e.MissingOrder=6]="MissingOrder",e[e.MissingOrderConfig=7]="MissingOrderConfig",e[e.MissingOrderId=8]="MissingOrderId",e[e.MissingPayment=9]="MissingPayment",e[e.MissingPaymentId=10]="MissingPaymentId",e[e.MissingPaymentInstrument=11]="MissingPaymentInstrument",e[e.MissingPaymentMethod=12]="MissingPaymentMethod",e[e.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",e[e.MissingPaymentStatus=14]="MissingPaymentStatus",e[e.MissingPaymentToken=15]="MissingPaymentToken",e[e.MissingShippingAddress=16]="MissingShippingAddress"}(e||(e={}));class r extends s{constructor(t){super(function(t){switch(t){case e.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case e.MissingCart:return"Unable to proceed because cart data is unavailable.";case e.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case e.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case e.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case e.MissingCheckoutConfig:case e.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case e.MissingOrder:return"Unable to proceed because order data is unavailable.";case e.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case e.MissingPayment:return"Unable to proceed because payment data is unavailable.";case e.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case e.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case e.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(t)),this.subtype=t,this.name="MissingDataError",this.type="missing_data"}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(t||(t={}));class a extends s{constructor(e){super(function(e){switch(e){case t.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case t.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case t.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case t.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}class o extends s{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class c extends o{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}class d extends s{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}class u extends s{constructor(e){super(e||"Payment process was cancelled."),this.name="PaymentMethodCancelledError",this.type="payment_cancelled"}}const l={body:{},headers:{},status:0};class m extends s{constructor(e,{message:t,errors:i}={}){const{body:n,headers:s,status:r}=e||l;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=n,this.headers=s,this.status=r,this.errors=i||[]}}class p extends m{constructor(e){super(e,{message:"There is a problem processing your payment. Please try again later."}),this.name="PaymentMethodInvalidError",this.type="payment_method_invalid"}}class g{constructor(e){this._decimalPlaces=e}toInteger(e){return Math.round(e*Math.pow(10,this._decimalPlaces))}}var h,f=function(e,t,i,n){return new(i||(i=Promise))(function(s,r){function a(e){try{c(n.next(e))}catch(e){r(e)}}function o(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,o)}c((n=n.apply(e,t||[])).next())})};class y{constructor(e,t){this.paymentIntegrationService=e,this.affirmScriptLoader=t}initialize(t){return f(this,void 0,void 0,function*(){yield this.paymentIntegrationService.loadPaymentMethod(t.methodId);const i=this.paymentIntegrationService.getState(),{clientToken:n,config:{testMode:s}}=i.getPaymentMethodOrThrow(t.methodId);if(!n)throw new r(e.MissingPaymentMethod);this.affirm=yield this.affirmScriptLoader.load(n,s)})}execute(e,i){var n;return f(this,void 0,void 0,function*(){const s=null===(n=e.payment)||void 0===n?void 0:n.methodId,{useStoreCredit:r}=e;if(!this.affirm)throw new a(t.PaymentNotInitialized);if(!s)throw new c(["payment.methodId"]);yield this.paymentIntegrationService.submitOrder({useStoreCredit:r},i);const o={methodId:s,paymentData:{nonce:(yield this.initializeAffirmCheckout()).checkout_token}};yield this.paymentIntegrationService.submitPayment(o)})}deinitialize(){return this.affirm&&(this.affirm=void 0),Promise.resolve()}finalize(){return Promise.reject(new d)}initializeAffirmCheckout(){var e;return null===(e=this.affirm)||void 0===e||e.checkout(this.getCheckoutInformation()),new Promise((e,t)=>{var i,n;null===(i=this.affirm)||void 0===i||i.checkout.open({onFail:e=>{"canceled"===e.reason?t(new u):t(new p)},onSuccess:t=>{e(t)}}),null===(n=this.affirm)||void 0===n||n.ui.error.on("close",()=>{t(new u)})})}getCheckoutInformation(){const t=this.paymentIntegrationService.getState(),i=t.getStoreConfig(),n=t.getConsignments(),s=t.getOrder(),a=t.getCart();if(!i)throw new r(e.MissingCheckoutConfig);if(!s)throw new r(e.MissingCheckout);const o=new g(s.currency.decimalPlaces),c=this.getBillingAddress(),d=this.getShippingAddress(),u=((e,t)=>!!e&&(!!e.lineItems.physicalItems.some(e=>e.isShippingRequired)||!(!t||!e.lineItems.customItems)&&e.lineItems.customItems.length>0))(a,i)&&d?d:c;return{merchant:{user_confirmation_url:i.links.checkoutLink,user_cancel_url:i.links.checkoutLink,user_confirmation_url_action:"POST"},shipping:u,billing:c,items:this.getItems(o,s),metadata:{shipping_type:this.getShippingType(n),mode:"modal",platform_type:"BigCommerce",platform_version:"",platform_affirm:""},discounts:this.getDiscounts(o,s),order_id:s.orderId?s.orderId.toString():"",shipping_amount:o.toInteger(s.shippingCostTotal),tax_amount:o.toInteger(s.taxTotal),total:o.toInteger(s.orderAmount)}}getShippingType(e){if(!e)return"";const t=e[0];return(null==t?void 0:t.selectedShippingOption)?t.selectedShippingOption.type:""}getBillingAddress(){const t=this.paymentIntegrationService.getState().getBillingAddress();if(!t)throw new r(e.MissingBillingAddress);return{name:{first:t.firstName,last:t.lastName,full:`${t.firstName} ${t.lastName}`},address:{line1:t.address1,line2:t.address2,city:t.city,state:t.stateOrProvinceCode,zipcode:t.postalCode,country:t.countryCode},phone_number:t.phone,email:t.email}}getShippingAddress(){const e=this.paymentIntegrationService.getState().getShippingAddress();if(e)return{name:{first:e.firstName,last:e.lastName,full:`${e.firstName} ${e.lastName}`},address:{line1:e.address1,line2:e.address2,city:e.city,state:e.stateOrProvinceCode,zipcode:e.postalCode,country:e.countryCode},phone_number:e.phone}}getItems(e,t){const i=[];return t.lineItems.physicalItems.forEach(t=>{i.push({display_name:t.name,sku:t.sku,unit_price:e.toInteger(t.salePrice),qty:t.quantity,item_image_url:t.imageUrl,item_url:t.url,categories:this.getCategories(t.categories)})}),t.lineItems.digitalItems.forEach(t=>{i.push({display_name:t.name,sku:t.sku,unit_price:e.toInteger(t.salePrice),qty:t.quantity,item_image_url:t.imageUrl,item_url:t.url,categories:this.getCategories(t.categories)})}),t.lineItems.giftCertificates.forEach(t=>{i.push({display_name:t.name,sku:"",unit_price:e.toInteger(t.amount),qty:1,item_image_url:"",item_url:""})}),t.lineItems.customItems&&t.lineItems.customItems.forEach(t=>{i.push({display_name:t.name,sku:t.sku,unit_price:e.toInteger(t.listPrice),qty:t.quantity,item_image_url:"",item_url:""})}),i}getDiscounts(e,t){const i={};return t.coupons.forEach(t=>{t.discountedAmount>0&&(i[t.code]={discount_amount:e.toInteger(t.discountedAmount),discount_display_name:t.displayName})}),t.discountAmount>0&&(i.DISCOUNTED_AMOUNT={discount_amount:e.toInteger(t.discountAmount),discount_display_name:"discount"}),i}getCategories(e){return e?e.map(e=>e.map(e=>e.name)):[[]]}}class b extends s{constructor(e){super(e||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}!function(e){e.PROD="//cdn1.affirm.com/js/v2/affirm.js",e.SANDBOX="//cdn1-sandbox.affirm.com/js/v2/affirm.js"}(h||(h={}));class I{constructor(e=window){this.affirmWindow=e}load(e="",t){const i=t?h.SANDBOX:h.PROD;if(function(e,t,i,n,s,r,a){const o=e[i]||{},c=document.createElement(r),d=document.getElementsByTagName(r)[0],u=function(e,t,i){return function(){e[t]._.push([i,arguments])}};o[n]=u(o,n,"set");const l=o[n];o[s]={},o[s]._=[],l._=[],o._=[],o[s][a]=u(o,s,a),o.jsReady=function(){o._.push([a,arguments])};let m=0;for(const e="set add save post open empty reset on off trigger ready setProduct".split(" ");m<e.length;m++)l[e[m]]=u(o,n,e[m]);let p=0;for(const e=["get","token","url","items"];p<e.length;p++)l[e[p]]=function(){};c.async=!0,c.src=t[r],d.parentNode&&d.parentNode.insertBefore(c,d),delete t[r],l(t),e[i]=o}(window,{public_api_key:e,script:i},"affirm","checkout","ui","script","ready"),!this.affirmWindow.affirm)throw new b;return Promise.resolve(this.affirmWindow.affirm)}}const _=Object.assign(e=>new y(e,new I),{resolveIds:[{id:"affirm"}]});module.exports=n})();
//# sourceMappingURL=affirm.js.map