(()=>{"use strict";var e={780:e=>{e.exports=require("iframe-resizer")},252:e=>{e.exports=require("iframe-resizer/js/iframeResizer.contentWindow")}},t={};function o(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{o.r(n),o.d(n,{createEmbeddedCheckoutMessenger:()=>j,embedCheckout:()=>P});const e=require("@bigcommerce/request-sender"),t=require("tslib");var r={size:70,color:"#d9d9d9",backgroundColor:"#ffffff"},i="embedded-checkout-loading-indicator-rotation";const s=function(){function e(e){this.styles=(0,t.__assign)((0,t.__assign)({},r),e&&e.styles),this.defineAnimation(),this.container=this.buildContainer(),this.indicator=this.buildIndicator(),this.container.appendChild(this.indicator)}return e.prototype.show=function(e){if(e){var t=document.getElementById(e);if(!t)throw new Error("Unable to attach the loading indicator because the parent ID is not valid.");t.appendChild(this.container)}this.container.style.visibility="visible",this.container.style.opacity="1"},e.prototype.hide=function(){var e=this,t=function(){e.container.style.visibility="hidden",e.container.removeEventListener("transitionend",t)};this.container.addEventListener("transitionend",t),this.container.style.opacity="0"},e.prototype.buildContainer=function(){var e=document.createElement("div");return e.style.display="block",e.style.bottom="0",e.style.left="0",e.style.height="100%",e.style.width="100%",e.style.position="absolute",e.style.right="0",e.style.top="0",e.style.transition="all 250ms ease-out",e.style.opacity="0",e},e.prototype.buildIndicator=function(){var e=document.createElement("div");return e.style.display="block",e.style.width=this.styles.size+"px",e.style.height=this.styles.size+"px",e.style.borderRadius=this.styles.size+"px",e.style.border="solid 1px",e.style.borderColor=this.styles.backgroundColor+" "+this.styles.backgroundColor+" "+this.styles.color+" "+this.styles.color,e.style.margin="0 auto",e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.top="50%",e.style.transform="translateY(-50%) rotate(0deg)",e.style.transformStyle="preserve-3d",e.style.animation=i+" 500ms infinite cubic-bezier(0.69, 0.31, 0.56, 0.83)",e},e.prototype.defineAnimation=function(){var e;if(!document.getElementById(i)){var t=document.createElement("style");t.id=i,null===(e=document.head)||void 0===e||e.appendChild(t),t.sheet instanceof CSSStyleSheet&&t.sheet.insertRule("\n                @keyframes "+i+" {\n                    0% { transform: translateY(-50%) rotate(0deg); }\n                    100% { transform: translateY(-50%) rotate(360deg); }\n                }\n            ",0)}},e}(),a=function(e){function o(t){var o,n,r=this.constructor,i=e.call(this,t||"An unexpected error has occurred.")||this;return i.name="StandardError",i.type="standard",o=i,n=r.prototype,Object.setPrototypeOf?Object.setPrototypeOf(o,n):o.__proto__=n,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(i,r):i.stack=new Error(i.message).stack,i}return(0,t.__extends)(o,e),o}(Error),c=function(e){function o(t){var o=e.call(this,t||"Invalid arguments have been provided.")||this;return o.name="InvalidArgumentError",o.type="invalid_argument",o}return(0,t.__extends)(o,e),o}(a);function d(e){if(!/^(https?:)?\/\//.test(e))throw new c("The provided URL must be absolute.");var t=document.createElement("a");t.href=e;var o=t.port&&-1!==e.indexOf(t.hostname+":"+t.port)?t.port:"";return{hash:t.hash,hostname:t.hostname,href:t.href,origin:t.protocol+"//"+t.hostname+(o?":"+o:""),pathname:t.pathname,port:o,protocol:t.protocol,search:t.search}}const u=function(e,o,n){return o&&n?p(0,o,n):function(e){var o=function(e){function o(){return null!==e&&e.apply(this,arguments)||this}return(0,t.__extends)(o,e),o}(e);return Object.getOwnPropertyNames(e.prototype).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e.prototype,t);n&&"constructor"!==t&&Object.defineProperty(o.prototype,t,p(e.prototype,t,n))})),o}(e)};function p(e,o,n){if("function"!=typeof n.value)return n;var r=n.value;return{get:function(){var e=r.bind(this);return Object.defineProperty(this,o,(0,t.__assign)((0,t.__assign)({},n),{value:e})),e},set:function(e){r=e}}}function h(e,t){return e.type===t}const l=function(){function e(e){var t;this._sourceOrigins=[d(e).origin,(t=d(e),d(0===t.hostname.indexOf("www")?t.href:t.href.replace(t.hostname,"www."+t.hostname))).origin],this._isListening=!1,this._listeners={}}return e.prototype.listen=function(){this._isListening||(this._isListening=!0,window.addEventListener("message",this._handleMessage))},e.prototype.stopListen=function(){this._isListening&&(this._isListening=!1,window.removeEventListener("message",this._handleMessage))},e.prototype.addListener=function(e,t){var o=this._listeners[e];o||(this._listeners[e]=o=[]),-1===o.indexOf(t)&&o.push(t)},e.prototype.removeListener=function(e,t){var o=this._listeners[e];if(o){var n=o.indexOf(t);n>=0&&o.splice(n,1)}},e.prototype.trigger=function(e){var t=this._listeners[e.type];t&&t.forEach((function(t){return t(e)}))},e.prototype._handleMessage=function(e){-1!==this._sourceOrigins.indexOf(e.origin)&&h(e.data,e.data.type)&&this.trigger(e.data)},(0,t.__decorate)([u],e.prototype,"_handleMessage",null),e}(),m=require("rxjs"),f=require("rxjs/operators"),y=function(){function e(e,t){this._targetWindow=t,this._targetOrigin="*"===e?"*":d(e).origin}return e.prototype.post=function(e,t){var o=this,n=this._targetWindow;if(window!==n){if(!n)throw new Error("Unable to post message because target window is not set.");var r=t&&(0,m.fromEvent)(window,"message").pipe((0,f.filter)((function(e){return e.origin===o._targetOrigin&&h(e.data,e.data.type)&&-1!==[t.successType,t.errorType].indexOf(e.data.type)})),(0,f.map)((function(e){if(t.errorType===e.data.type)throw e.data;return e.data})),(0,f.take)(1)).toPromise();return n.postMessage(e,this._targetOrigin),r}},e.prototype.setTarget=function(e){this._targetWindow=e},e}(),g=require("local-storage-fallback");var _=o.n(g);const v=function(){function e(e){this._namespace=e}return e.prototype.getItem=function(e){var t=_().getItem(this.withNamespace(e));if(null===t)return null;try{return JSON.parse(t)}catch(t){return this.removeItem(this.withNamespace(e)),null}},e.prototype.getItemOnce=function(e){var t=this.getItem(e);return this.removeItem(e),t},e.prototype.setItem=function(e,t){return _().setItem(this.withNamespace(e),JSON.stringify(t))},e.prototype.removeItem=function(e){return _().removeItem(this.withNamespace(e))},e.prototype.withNamespace=function(e){return this._namespace+"."+e},e}();var w;!function(e){e.CheckoutComplete="CHECKOUT_COMPLETE",e.CheckoutError="CHECKOUT_ERROR",e.CheckoutLoaded="CHECKOUT_LOADED",e.FrameError="FRAME_ERROR",e.FrameLoaded="FRAME_LOADED",e.SignedOut="SIGNED_OUT"}(w||(w={}));var b={body:{},headers:{},status:0};const E=function(e){function o(t){var o=e.call(this,t,{message:t.body.title})||this;return o.name="InvalidLoginTokenError",o.type="invalid_login_token",o}return(0,t.__extends)(o,e),o}(function(e){function o(t,o){var n=void 0===o?{}:o,r=n.message,i=n.errors,s=this,a=t||b,c=a.body,d=a.headers,u=a.status;return(s=e.call(this,r||"An unexpected error has occurred.")||this).name="RequestError",s.type="request",s.body=c,s.headers=d,s.status=u,s.errors=i||[],s}return(0,t.__extends)(o,e),o}(a));var C;!function(e){e.MissingContainer="missing_container",e.MissingContent="missing_content",e.UnknownError="unknown_error"}(C||(C={}));const L=function(e){function o(t,o){void 0===o&&(o=C.UnknownError);var n=e.call(this,t||"Unable to embed the checkout form.")||this;return n.subtype=o,n.name="NotEmbeddableError",n.type="not_embeddable",n}return(0,t.__extends)(o,e),o}(a);var O;!function(e){e.StyleConfigured="STYLE_CONFIGURED"}(O||(O={}));var k="isCookieAllowed",I="lastAllowCookieAttempt";const S=function(){function e(e,t,o,n,r,i,s,a){var c=this;this._iframeCreator=e,this._messageListener=t,this._messagePoster=o,this._loadingIndicator=n,this._requestSender=r,this._storage=i,this._location=s,this._options=a,this._isAttached=!1,this._options.onComplete&&this._messageListener.addListener(w.CheckoutComplete,this._options.onComplete),this._options.onError&&this._messageListener.addListener(w.CheckoutError,this._options.onError),this._options.onLoad&&this._messageListener.addListener(w.CheckoutLoaded,this._options.onLoad),this._options.onFrameLoad&&this._messageListener.addListener(w.FrameLoaded,this._options.onFrameLoad),this._options.onSignOut&&this._messageListener.addListener(w.SignedOut,this._options.onSignOut),this._messageListener.addListener(w.FrameLoaded,(function(){return c._configureStyles()}))}return e.prototype.attach=function(){var e=this;return this._isAttached?Promise.resolve(this):(this._isAttached=!0,this._messageListener.listen(),this._loadingIndicator.show(this._options.containerId),this._allowCookie().then((function(){return e._attemptLogin()})).then((function(t){return e._iframeCreator.createFrame(t,e._options.containerId)})).then((function(t){e._iframe=t,e._configureStyles(),e._loadingIndicator.hide()})).catch((function(t){return e._isAttached=!1,e._retryAllowCookie(t).catch((function(){throw e._messageListener.trigger({type:w.FrameError,payload:t}),e._loadingIndicator.hide(),t}))})).then((function(){return e})))},e.prototype.detach=function(){this._isAttached&&(this._isAttached=!1,this._messageListener.stopListen(),this._iframe&&this._iframe.parentNode&&(this._iframe.parentNode.removeChild(this._iframe),this._iframe.iFrameResizer.close()))},e.prototype._configureStyles=function(){this._iframe&&this._iframe.contentWindow&&this._options.styles&&(this._messagePoster.setTarget(this._iframe.contentWindow),this._messagePoster.post({type:O.StyleConfigured,payload:this._options.styles}))},e.prototype._attemptLogin=function(){return/^\/login\/token/.test(d(this._options.url).pathname)?this._requestSender.post(this._options.url).then((function(e){return e.body.redirectUrl})).catch((function(e){return Promise.reject(new E(e))})):Promise.resolve(this._options.url)},e.prototype._allowCookie=function(){if(this._storage.getItem(k))return Promise.resolve();this._storage.setItem(k,!0),this._storage.setItem(I,Date.now());var e=d(this._options.url).origin+"/embedded-checkout/allow-cookie?returnUrl="+encodeURIComponent(this._location.href);return document.body.style.visibility="hidden",this._location.replace(e),new Promise((function(){}))},e.prototype._retryAllowCookie=function(e){var t=Number(this._storage.getItem(I));return(!t||Date.now()-t>6e5)&&e instanceof L&&e.subtype===C.MissingContent?(this._storage.removeItem(I),this._storage.removeItem(k),this._allowCookie()):Promise.reject()},(0,t.__decorate)([u],e)}(),M=function(){function e(e){this._options=e}return e.prototype.createFrame=function(e,t){var o=document.getElementById(t),n=(this._options||{}).timeout,r=void 0===n?6e4:n;if(!o)throw new L("Unable to embed the iframe because the container element could not be found.",C.MissingContainer);var i=document.createElement("iframe");return i.src=e,i.style.border="none",i.style.display="none",i.style.width="100%",i.allowPaymentRequest=!0,o.appendChild(i),this._toResizableFrame(i,r).catch((function(e){throw o.removeChild(i),e}))},e.prototype._toResizableFrame=function(e,t){return new Promise((function(n,r){var i=window.setTimeout((function(){r(new L("Unable to embed the iframe because the content could not be loaded."))}),t),s=function(t){var i,s;if(t.origin===d(e.src).origin&&(h(t.data,w.FrameError)&&(a(),r(new L(t.data.payload.message,C.MissingContent))),h(t.data,w.FrameLoaded))){e.style.display="";var c=(i={scrolling:!1,sizeWidth:!1,heightCalculationMethod:t.data.payload&&t.data.payload.contentId?"taggedElement":"lowestElement"},s=e,(0,o(780).iframeResizer)(i,s));a(),n(c[c.length-1])}},a=function(){window.removeEventListener("message",s),window.clearTimeout(i)};window.addEventListener("message",s)}))},e}();var x="BigCommerce.EmbeddedCheckout";function P(t){var o=d(t.url).origin;return new S(new M,new l(o),new y(o),new s({styles:t.styles&&t.styles.loadingIndicator}),(0,e.createRequestSender)(),new v(x),window.location,t).attach()}function F(e){if(e.payload&&e.payload.contentId){var t=document.getElementById(e.payload.contentId);t&&!t.hasAttribute("data-iframe-height")&&t.setAttribute("data-iframe-height","")}}function A(e){return"object"==typeof e&&null!==e&&"message"in e&&"type"in e}const R=function(){function e(e,t,o,n){void 0===n&&(n={}),this._messageListener=e,this._messagePoster=t,this._untargetedMessagePoster=o,this._messageHandlers=n,this._messageListener.listen()}return e.prototype.postComplete=function(){var e={type:w.CheckoutComplete};this._postMessage(e)},e.prototype.postError=function(e){var t={type:w.CheckoutError,payload:this._transformError(e)};this._postMessage(t)},e.prototype.postFrameError=function(e){var t={type:w.FrameError,payload:this._transformError(e)};this._postMessage(t,{untargeted:!0})},e.prototype.postFrameLoaded=function(e){var t={type:w.FrameLoaded,payload:e};this._postMessage(t)},e.prototype.postLoaded=function(){var e={type:w.CheckoutLoaded};this._postMessage(e)},e.prototype.postSignedOut=function(){var e={type:w.SignedOut};this._postMessage(e)},e.prototype.receiveStyles=function(e){this._messageListener.addListener(O.StyleConfigured,(function(t){var o=t.payload;e(o)}))},e.prototype._postMessage=function(e,t){if(this._notifyMessageHandlers(e),t&&t.untargeted)return this._untargetedMessagePoster.post(e);this._messagePoster.post(e)},e.prototype._notifyMessageHandlers=function(e){var t=this;Object.keys(this._messageHandlers).forEach((function(o){if(e.type===o){var n=t._messageHandlers[o];n&&n.call(null,e)}}))},e.prototype._transformError=function(e){return{message:e.message,type:A(e)?e.type:void 0,subtype:A(e)?e.subtype:void 0}},(0,t.__decorate)([u],e)}(),T=function(){function e(){}return e.prototype.postComplete=function(){},e.prototype.postError=function(){},e.prototype.postFrameError=function(){},e.prototype.postFrameLoaded=function(){},e.prototype.postLoaded=function(){},e.prototype.postSignedOut=function(){},e.prototype.receiveStyles=function(){},(0,t.__decorate)([u],e)}();function j(e){var t;o(252);var n=e.parentWindow||window.parent;return window===n?new T:new R(new l(e.parentOrigin),new y(e.parentOrigin,n),new y("*",n),((t={})[w.FrameLoaded]=F,t))}})(),module.exports=n})();
//# sourceMappingURL=embedded-checkout.js.map