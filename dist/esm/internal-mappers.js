import{filter as t,find as e,keyBy as n,noop as i,reduce as o,some as a}from"lodash";import{default as r}from"shallowequal";var s={};function c(t,e){let n;return function(t){return void 0!==t.id}(t)?n=t.id:e&&e.length&&(n=e[0].id),{id:n,firstName:t.firstName,lastName:t.lastName,company:t.company,addressLine1:t.address1,addressLine2:t.address2,city:t.city,province:t.stateOrProvince,provinceCode:t.stateOrProvinceCode,postCode:t.postalCode,country:t.country,countryCode:t.countryCode,phone:t.phone,customFields:t.customFields}}s.d=(t,e)=>{for(var n in e)s.o(e,n)&&!s.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);class u{constructor(t){this._decimalPlaces=t}toInteger(t){return Math.round(t*Math.pow(10,this._decimalPlaces))}}const d=["per_item_discount","percentage_discount","per_total_discount","shipping_discount","free_shipping"];function p(t){return{code:t.code,discount:t.displayName,discountType:d.indexOf(t.couponType)}}function m(t){return{code:t.code,discountedAmount:t.used,remainingBalance:t.remaining,giftCertificate:{balance:t.balance,code:t.code,purchaseDate:t.purchaseDate}}}function l(t){const e=[];return(t||[]).forEach(t=>{(t.banners||[]).forEach(t=>{e.push({placeholders:[],discountType:null,message:"",messageHtml:t.text})})}),e}function g(t,e,n,i="id"){const o=new u(n);return{id:t[i],imageUrl:t.imageUrl,amount:t.extendedListPrice,amountAfterDiscount:t.extendedSalePrice,discount:t.discountAmount,integerAmount:o.toInteger(t.extendedListPrice),integerAmountAfterDiscount:o.toInteger(t.extendedSalePrice),integerDiscount:o.toInteger(t.discountAmount),integerUnitPrice:o.toInteger(t.listPrice),integerUnitPriceAfterDiscount:o.toInteger(t.salePrice),downloadsPageUrl:t.downloadPageUrl,name:t.name,quantity:t.quantity,brand:t.brand,sku:t.sku,categoryNames:t.categoryNames,variantId:t.variantId,productId:t.productId,attributes:(t.options||[]).map(t=>({name:t.name,value:t.value})),addedByPromotion:t.addedByPromotion,type:e}}function h(t,e,n="id"){return Object.keys(t).reduce((i,o)=>[...i,...t[o].map(t=>"giftCertificates"===o?function(t,e){const n=new u(e);return{id:t.id,imageUrl:"",name:t.name,amount:t.amount,amountAfterDiscount:t.amount,discount:0,integerAmount:n.toInteger(t.amount),integerAmountAfterDiscount:n.toInteger(t.amount),integerUnitPrice:n.toInteger(t.amount),integerUnitPriceAfterDiscount:n.toInteger(t.amount),integerDiscount:0,quantity:1,sender:t.sender,recipient:t.recipient,type:"ItemGiftCertificateEntity",attributes:[],variantId:null}}(t,e):g(t,function(t){switch(t){case"physicalItems":return"ItemPhysicalEntity";case"digitalItems":return"ItemDigitalEntity";case"giftCertificates":return"ItemGiftCertificateEntity";default:return""}}(o),e,n))],[])}function f(t){const e=t.cart.currency.decimalPlaces,i=new u(e);return{id:t.cart.id,items:h(t.cart.lineItems,e),currency:t.cart.currency.code,coupon:{discountedAmount:o(t.cart.coupons,(t,e)=>t+e.discountedAmount,0),coupons:t.cart.coupons.map(p)},discount:{amount:t.cart.discountAmount,integerAmount:i.toInteger(t.cart.discountAmount)},discountNotifications:l(t.promotions),giftCertificate:{totalDiscountedAmount:o(t.giftCertificates,(t,e)=>t+e.used,0),appliedGiftCertificates:n(t.giftCertificates.map(m),"code")},shipping:{amount:t.shippingCostTotal,integerAmount:i.toInteger(t.shippingCostTotal),amountBeforeDiscount:t.shippingCostBeforeDiscount,integerAmountBeforeDiscount:i.toInteger(t.shippingCostBeforeDiscount),required:a(t.cart.lineItems.physicalItems,t=>t.isShippingRequired)},subtotal:{amount:t.subtotal,integerAmount:i.toInteger(t.subtotal)},storeCredit:{amount:t.customer?t.customer.storeCredit:0},taxSubtotal:{amount:t.taxTotal,integerAmount:i.toInteger(t.taxTotal)},taxes:t.taxes,taxTotal:{amount:t.taxTotal,integerAmount:i.toInteger(t.taxTotal)},handling:{amount:t.handlingCostTotal,integerAmount:i.toInteger(t.handlingCostTotal)},grandTotal:{amount:t.grandTotal,integerAmount:i.toInteger(t.grandTotal)}}}function I(t,e){const n=t.firstName||e.firstName||"",i=t.lastName||e.lastName||"";return{addresses:(t.addresses||[]).map(t=>c(t)),customerId:t.id,isGuest:t.isGuest,storeCredit:t.storeCredit,email:t.email||e.email||"",firstName:n,lastName:i,name:t.fullName||[n,i].join(" "),customerGroupName:t.customerGroup&&t.customerGroup.name}}function y(t,e={}){const n=t.currency.decimalPlaces,i=new u(n);return{id:t.orderId,items:h(t.lineItems,t.currency.decimalPlaces,"productId"),orderId:t.orderId,currency:t.currency.code,customerCanBeCreated:t.customerCanBeCreated,payment:b(t.payments,e.payment),subtotal:{amount:t.baseAmount,integerAmount:i.toInteger(t.baseAmount)},coupon:{discountedAmount:o(t.coupons,(t,e)=>t+e.discountedAmount,0),coupons:t.coupons.map(p)},discount:{amount:t.discountAmount,integerAmount:i.toInteger(t.discountAmount)},token:e.orderToken,callbackUrl:e.callbackUrl,discountNotifications:[],giftCertificate:C(t.payments),socialData:v(t),status:t.status,hasDigitalItems:t.hasDigitalItems,isDownloadable:t.isDownloadable,isComplete:t.isComplete,shipping:{amount:t.shippingCostTotal,integerAmount:i.toInteger(t.shippingCostTotal),amountBeforeDiscount:t.shippingCostBeforeDiscount,integerAmountBeforeDiscount:i.toInteger(t.shippingCostBeforeDiscount)},storeCredit:{amount:A(t.payments)},taxes:t.taxes,taxTotal:{amount:t.taxTotal,integerAmount:i.toInteger(t.taxTotal)},handling:{amount:t.handlingCostTotal,integerAmount:i.toInteger(t.handlingCostTotal)},grandTotal:{amount:t.orderAmount,integerAmount:t.orderAmountAsInteger}}}function A(t){const n=e(t,{providerId:"storecredit"});return n?n.amount:0}function C(e){const i=t(e,{providerId:"giftcertificate"});return{totalDiscountedAmount:o(i,(t,e)=>e.amount+t,0),appliedGiftCertificates:n(i.map(t=>({code:t.detail.code,discountedAmount:t.amount,remainingBalance:t.detail.remaining,giftCertificate:{balance:t.amount+t.detail.remaining,code:t.detail.code,purchaseDate:""}})),"code")}}function b(t,n={}){const i=e(t,_);return i?{id:i.providerId,status:(o=i.detail.step,`PAYMENT_STATUS_${o}`),helpText:i.detail.instructions,returnUrl:n.returnUrl}:{};var o}function _(t){return"giftcertificate"!==t.providerId&&"storecredit"!==t.providerId}function v(t){const n={};return[...t.lineItems.physicalItems,...t.lineItems.digitalItems].forEach(t=>{var i;n[t.id]=(i=t,["fb","tw","gp"].reduce((t,n)=>{const o=i.socialMedia&&e(i.socialMedia,t=>t.code===n);return o?(t[n]={name:i.name,description:i.name,image:i.imageUrl,url:o.link,shareText:o.text,sharingLink:o.link,channelName:o.channel,channelCode:o.code},t):t},{}))}),n}function x(t,e){const n=t.consignments&&t.consignments[0];return{orderComment:t.customerMessage,shippingOption:n&&n.selectedShippingOption?n.selectedShippingOption.id:void 0,billingAddress:t.billingAddress?c(t.billingAddress):{},shippingAddress:e&&c(e,t.consignments)}}function M(t,e){return{description:t.description,module:t.type,price:t.cost,id:t.id,selected:e,isRecommended:t.isRecommended,imageUrl:t.imageUrl,transitTime:t.transitTime}}function T(t){return t.reduce((t,e)=>{let n;return e.availableShippingOptions&&e.availableShippingOptions.length?n=e.availableShippingOptions:e.selectedShippingOption&&(n=[e.selectedShippingOption]),Object.assign(Object.assign({},t),{[e.id]:(n||[]).map(t=>{const n=e.selectedShippingOption&&e.selectedShippingOption.id;return M(t,t.id===n)})})},{})}function D(t){return Object.prototype.hasOwnProperty.call(t,"cacheKey")}class P{constructor(t){this._lastId=0,this._map={maps:[]},this._usedMaps=[],this._options=Object.assign({maxSize:0,isEqual:r,onExpire:i},t)}getKey(...t){const e=this._resolveMap(...t),{index:n,parentMap:i}=e;let{map:o}=e;return o&&o.cacheKey?o.usedCount++:o=this._generateMap(i,t.slice(n)),this._removeLeastUsedMap(o),o.cacheKey}getUsedCount(...t){const{map:e}=this._resolveMap(...t);return e?e.usedCount:0}_resolveMap(...t){let e=0,n=this._map;for(;n.maps.length;){let i=!1;for(let o=0;o<n.maps.length;o++){const a=n.maps[o];if(this._options.isEqual(a.value,t[e])){if(n.maps.unshift(...n.maps.splice(o,1)),(0===t.length||e===t.length-1)&&D(a))return{index:e,map:a,parentMap:n};i=!0,n=a,e++;break}}if(!i)break}return{index:e,parentMap:n}}_generateMap(t,e){let n,i=0,o=t;do{n={maps:[],parentMap:o,usedCount:1,value:e[i]},o.maps.unshift(n),o=n,i++}while(i<e.length);const a=n;return a.cacheKey=""+ ++this._lastId,a}_removeLeastUsedMap(t){if(!this._options.maxSize)return;const e=this._usedMaps.indexOf(t);if(this._usedMaps.splice(-1===e?0:e,-1===e?0:1,t),this._usedMaps.length<=this._options.maxSize)return;const n=this._usedMaps.pop();n&&(this._removeMap(n),this._options.onExpire(n.cacheKey))}_removeMap(t){t.parentMap&&(t.parentMap.maps.splice(t.parentMap.maps.indexOf(t),1),function(t){return Object.prototype.hasOwnProperty.call(t,"parentMap")}(t.parentMap)||this._removeMap(t.parentMap))}}export{P as CacheKeyResolver,c as mapToInternalAddress,f as mapToInternalCart,p as mapToInternalCoupon,I as mapToInternalCustomer,m as mapToInternalGiftCertificate,g as mapToInternalLineItem,h as mapToInternalLineItems,y as mapToInternalOrder,x as mapToInternalQuote,M as mapToInternalShippingOption,T as mapToInternalShippingOptions};
//# sourceMappingURL=internal-mappers.js.map