import{getScriptLoader as t}from"@bigcommerce/script-loader";import{noop as e}from"rxjs";import{default as n}from"local-storage-fallback";import{isObject as i}from"lodash";import{stringifyUrl as o}from"query-string";var r,a,s={};function d(t,e){return Object.assign(t,{resolveIds:e})}s.d=(t,e)=>{for(var n in e)s.o(e,n)&&!s.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);class c extends Error{constructor(t){var e;super(t||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",e=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,e):this.__proto__=e,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class l extends c{constructor(t){super(t||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}!function(t){t[t.MissingBillingAddress=0]="MissingBillingAddress",t[t.MissingCart=1]="MissingCart",t[t.MissingCheckout=2]="MissingCheckout",t[t.MissingConsignments=3]="MissingConsignments",t[t.MissingCustomer=4]="MissingCustomer",t[t.MissingCheckoutConfig=5]="MissingCheckoutConfig",t[t.MissingOrder=6]="MissingOrder",t[t.MissingOrderConfig=7]="MissingOrderConfig",t[t.MissingOrderId=8]="MissingOrderId",t[t.MissingPayment=9]="MissingPayment",t[t.MissingPaymentId=10]="MissingPaymentId",t[t.MissingPaymentInstrument=11]="MissingPaymentInstrument",t[t.MissingPaymentMethod=12]="MissingPaymentMethod",t[t.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",t[t.MissingPaymentStatus=14]="MissingPaymentStatus",t[t.MissingPaymentToken=15]="MissingPaymentToken",t[t.MissingShippingAddress=16]="MissingShippingAddress"}(r||(r={}));class u extends c{constructor(t){super(function(t){switch(t){case r.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case r.MissingCart:return"Unable to proceed because cart data is unavailable.";case r.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case r.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case r.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case r.MissingCheckoutConfig:case r.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case r.MissingOrder:return"Unable to proceed because order data is unavailable.";case r.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case r.MissingPayment:return"Unable to proceed because payment data is unavailable.";case r.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case r.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case r.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(t)),this.subtype=t,this.name="MissingDataError",this.type="missing_data"}}class h extends c{constructor(t){super(t||"Unable to proceed because the client library of a payment method has thrown an unexpected error."),this.name="PaymentMethodFailedError",this.type="payment_method_client_invalid"}}!function(t){t[t.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",t[t.CustomerNotInitialized=1]="CustomerNotInitialized",t[t.PaymentNotInitialized=2]="PaymentNotInitialized",t[t.ShippingNotInitialized=3]="ShippingNotInitialized",t[t.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(a||(a={}));class m extends c{constructor(t){super(function(t){switch(t){case a.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case a.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case a.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case a.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(t)),this.subtype=t,this.name="NotInitializedError",this.type="not_initialized"}}const p={body:{},headers:{},status:0};class g extends c{constructor(t,{message:e,errors:n}={}){const{body:i,headers:o,status:r}=t||p;super(e||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=i,this.headers=o,this.status=r,this.errors=n||[]}}class y extends g{constructor(t){super(t,{message:"There is a problem processing your payment. Please try again later."}),this.name="PaymentMethodInvalidError",this.type="payment_method_invalid"}}var b,f,v,w=function(t,e,n,i){return new(n||(n=Promise))(function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}d((i=i.apply(t,e||[])).next())})};class C{constructor(t,e){this.paymentIntegrationService=t,this.boltScriptLoader=e,this.boltHostWindow=window}initialize(t){var e;return w(this,void 0,void 0,function*(){const{methodId:n,bolt:i}=t,{onInit:o}=i||{};if(!n)throw new l('Unable to proceed because "methodId" argument is not provided.');yield this.paymentIntegrationService.loadPaymentMethod(n);const a=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(n);if(!(null===(e=a.initializationData)||void 0===e?void 0:e.publishableKey))throw new u(r.MissingPaymentMethod);const{developerConfig:s,publishableKey:d}=a.initializationData;if(yield this.boltScriptLoader.loadBoltClient(d,a.config.testMode,s),o&&"function"==typeof o){const t=this.getCustomerEmail();o(yield this.hasBoltAccount(t),t)}})}deinitialize(){return Promise.resolve()}signIn(t,e){return w(this,void 0,void 0,function*(){return yield this.paymentIntegrationService.signInCustomer(t,e),Promise.resolve()})}signOut(t){return w(this,void 0,void 0,function*(){return yield this.paymentIntegrationService.signOutCustomer(t),Promise.resolve()})}executePaymentMethodCheckout(t){return w(this,void 0,void 0,function*(){const{continueWithCheckoutCallback:n=e,checkoutPaymentMethodExecuted:i,methodId:o}=t||{},r=this.getCustomerEmail();if(!o)throw new l('Unable to proceed because "methodId" argument is not provided.');if("function"!=typeof n)throw new l('Unable to proceed because "continueWithCheckoutCallback" argument is not provided and it must be a function.');if(r)return this.openBoltCheckoutModalOrThrow(r,o,n,i);n()})}openBoltCheckoutModalOrThrow(t,e,n,i){var o;return w(this,void 0,void 0,function*(){const r=this.getBoltClientOrThrow(),a=this.paymentIntegrationService.getState().getPaymentMethod(e);try{if(null===(o=null==a?void 0:a.initializationData)||void 0===o?void 0:o.embeddedOneClickEnabled){const e=yield this.hasBoltAccount(t);if(e){const e={close:()=>{n()}};yield r.openCheckout(t,e)}else n();"function"==typeof i&&i({hasBoltAccount:e})}else n()}catch(t){if(function(t){return"string"==typeof t.message&&"string"==typeof t.type&&("string"==typeof t.subtype||!t.subtype)&&t instanceof Error}(t)&&"MissingDataError"!==t.name&&"NotInitializedError"!==t.name)throw new h(t.message);throw t}})}getBoltClientOrThrow(){const t=this.boltHostWindow.BoltCheckout;if(!t)throw new m(a.PaymentNotInitialized);return t}hasBoltAccount(t){return w(this,void 0,void 0,function*(){const e=this.getBoltClientOrThrow();try{return yield e.hasBoltAccount(t)}catch(t){throw new y}})}getCustomerEmail(){const t=this.paymentIntegrationService.getState(),e=t.getCustomer(),n=t.getBillingAddress();return(null==e?void 0:e.email)||(null==n?void 0:n.email)||""}}class I extends c{constructor(t){super(t||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}!function(t){t.SandboxMode="bolt_sandbox",t.StagingMode="bolt_staging",t.DevelopmentMode="bolt_development"}(b||(b={})),function(t){t.Small="small",t.Medium="medium",t.Large="large"}(f||(f={})),function(t){t.Pill="pill",t.Rect="rect"}(v||(v={}));var M=function(t,e,n,i){return new(n||(n=Promise))(function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}d((i=i.apply(t,e||[])).next())})};class P{constructor(t,e=window){this.scriptLoader=t,this.boltHostWindow=e}loadBoltClient(t,e,n,i,o){return M(this,void 0,void 0,function*(){if(this.boltHostWindow.BoltCheckout)return this.boltHostWindow.BoltCheckout;if(!t)throw new l('Unable to initialize payment because "publishableKey" argument is not provided.');if(yield this.scriptLoader.loadScript(`//${this.getDomainURL(!!e,n)}/connect-bigcommerce.js`,this.getScriptOptions("bolt-connect",t,i,o)),yield this.scriptLoader.loadScript(`//${this.getDomainURL(!!e,n)}/track.js`,this.getScriptOptions("bolt-track",t)),!this.boltHostWindow.BoltCheckout)throw new I;return this.boltHostWindow.BoltCheckout})}loadBoltEmbedded(t,e,n){return M(this,void 0,void 0,function*(){if(yield this.scriptLoader.loadScript(`//${this.getDomainURL(!!e,n)}/embed.js`,{async:!0,attributes:{id:"bolt-embedded"}}),!this.boltHostWindow.Bolt)throw new I;return this.boltHostWindow.Bolt(t)})}getDomainURL(t,e){if(!t)return"connect.bolt.com";if(e)switch(e.developerMode){case b.StagingMode:return"connect-staging.bolt.com";case b.DevelopmentMode:return`connect.${e.developerDomain}`}return"connect-sandbox.bolt.com"}getScriptOptions(t,e,n,i){return{async:!0,attributes:Object.assign(Object.assign({id:t,"data-publishable-key":e},n&&{"data-shopping-cart-id":n}),i&&{"data-storefront-api-token":i})}}}const B=d(e=>new C(e,new P(t())),[{id:"bolt"}]);class S{constructor(t){this.storage=t}saveExtraItemsData(t,e){const n=[...e.physicalItems,...e.digitalItems].reduce((t,e)=>(t[e.productId]={brand:e.brand?e.brand:"",category:e.categoryNames?e.categoryNames.join(", "):""},t),{});try{return this.storage.setItem(this.getStorageKey(t),JSON.stringify(n)),n}catch(t){return{}}}readExtraItemsData(t){try{const e=this.storage.getItem(this.getStorageKey(t));if(!e)return null;const n=JSON.parse(e);return function(t){if(!i(t))return!1;const e=Object.values(t).some(t=>!i(t)||!("brand"in t)||!("category"in t));return Boolean(!e)}(n)?n:null}catch(t){return null}}clearExtraItemData(t){try{this.storage.removeItem(this.getStorageKey(t))}catch(t){}}getStorageKey(t){return t?`ORDER_ITEMS_${t}`:""}}class O extends c{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}class k extends l{constructor(t){let e="Unable to submit payment for the order because the payload is invalid.";t&&(e=`${e} Make sure the following fields are provided correctly: ${t.join(", ")}.`),super(e),this.name="PaymentArgumentInvalidError"}}class E extends c{constructor(t){super(t||"Payment process was cancelled."),this.name="PaymentMethodCancelledError",this.type="payment_cancelled"}}function z(t){return"object"==typeof t&&null!==t&&"shouldCreateAccount"in t}class x extends c{constructor(t){super(),this.errorCode=t,this.name="BoltPaymentsFieldError",this.type="bolt_payments_field_error",this.body={errors:[x.getError(t)]}}static getError(t){switch(t){case"1000":case"2000":case"3000":return{code:"invalid_number"};case"1001":case"2001":case"3001":return{code:"invalid_expiry_date"};case"1002":case"2002":return{code:"invalid_cvc"};case"1003":return{code:"invalid_zip"};case"2003":return{code:"incorrect_zip"};default:return{code:"general_error"}}}}var _=function(t,e,n,i){return new(n||(n=Promise))(function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}d((i=i.apply(t,e||[])).next())})};class U{constructor(t,e,n){this.paymentIntegrationService=t,this.boltScriptLoader=e,this.analyticsExtraItemsManager=n,this.useBoltClient=!1,this.useBoltEmbedded=!1}initialize(t){return _(this,void 0,void 0,function*(){const{bolt:e,methodId:n}=t,{containerId:i,onPaymentSelect:o,useBigCommerceCheckout:a}=e||{};if(!n)throw new l('Unable to initialize payment because "options.methodId" argument is not provided.');if(!a)return void(this.boltClient=yield this.boltScriptLoader.loadBoltClient());const s=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(t.methodId),{initializationData:d,config:c}=s,{publishableKey:h,developerConfig:m,embeddedOneClickEnabled:p}=d||{},{testMode:g}=c;if(!h)throw new u(r.MissingPaymentMethod);if(this.boltClient=yield this.boltScriptLoader.loadBoltClient(h,g,m),this.useBoltClient=!p,this.useBoltEmbedded=!!p,this.useBoltEmbedded){if(!i)throw new l('Unable to initialize payment because "options.bolt.containerId" argument is not provided.');if(!o)throw new l('Unable to initialize payment because "options.bolt.onPaymentSelect" argument is not provided.');this.boltEmbedded=yield this.boltScriptLoader.loadBoltEmbedded(h,g,m),this.mountBoltEmbeddedField(i),o(yield this.hasBoltAccount())}})}deinitialize(){var t;return null===(t=this.embeddedField)||void 0===t||t.unmount(),this.boltClient=void 0,this.boltEmbedded=void 0,Promise.resolve()}finalize(){return Promise.reject(new O)}execute(t,e){return _(this,void 0,void 0,function*(){this.setExtraItemsForAnalytics();const{payment:n}=t,o=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(t);o<i.length;o++)e.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(t,i[o])&&(n[i[o]]=t[i[o]])}return n}(t,["payment"]),{methodId:a,paymentData:s}=n||{};let d;if(!t.payment)throw new k(["payment"]);if(!a)throw new u(r.MissingPaymentMethod);if(!s||!function(t){return Boolean(i(t)&&("shouldSaveInstrument"in t||"nonce"in t||z(t)))}(s))throw new u(r.MissingPayment);yield this.paymentIntegrationService.submitOrder(o,e),d=this.useBoltClient?yield this.getBoltClientPaymentPayload(a,s,e):this.useBoltEmbedded?yield this.getBoltEmbeddedPaymentPayload(a,s):yield this.getBoltFullCheckoutPaymentPayload(a,s),yield this.paymentIntegrationService.submitPayment(d)})}getBoltClientPaymentPayload(t,e,n){return _(this,void 0,void 0,function*(){yield this.paymentIntegrationService.loadPaymentMethod(t,n);const i=this.paymentIntegrationService.getState(),o=i.getPaymentMethodOrThrow(t).clientToken,{isStoreCreditApplied:a}=i.getCheckoutOrThrow(),{shouldSaveInstrument:s}=e,d=this.getBoltClientOrThrow();if(yield this.paymentIntegrationService.applyStoreCredit(a),!o)throw new u(r.MissingPaymentMethod);const c=yield new Promise((t,e)=>{const n={success:(n,i)=>{n.reference?t(n):e(new h("Unable to proceed because transaction reference is unavailable. Please try again later.")),i()},close:()=>{e(new E)}};d.configure({orderToken:o},{},n).open()});return{methodId:t,paymentData:{nonce:c.reference,shouldSaveInstrument:s}}})}getBoltEmbeddedPaymentPayload(t,e){var n;return _(this,void 0,void 0,function*(){if(!z(e))throw new u(r.MissingPayment);const i=this.validateTokenizeResultOrThrow(yield null===(n=this.embeddedField)||void 0===n?void 0:n.tokenize());return{methodId:t,paymentData:{formattedPayload:{credit_card_token:{token:i.token,last_four_digits:i.last4,iin:i.bin,expiration_month:+i.expiration.split("-")[1],expiration_year:+i.expiration.split("-")[0]},provider_data:{create_account:!!e.shouldCreateAccount,embedded_checkout:!0}}}}})}getBoltFullCheckoutPaymentPayload(t,e){return _(this,void 0,void 0,function*(){yield this.setBoltOrderId();const n=this.getBoltClientOrThrow(),i=yield n.getTransactionReference();if(!i)throw new y;return{methodId:t,paymentData:Object.assign(Object.assign({},e),{nonce:i})}})}getBoltClientOrThrow(){if(!this.boltClient)throw new m(a.PaymentNotInitialized);return this.boltClient}getBoltEmbeddedOrThrow(){if(!this.boltEmbedded)throw new m(a.PaymentNotInitialized);return this.boltEmbedded}hasBoltAccount(){return _(this,void 0,void 0,function*(){const t=this.paymentIntegrationService.getState(),e=t.getCustomer(),n=t.getBillingAddress(),i=(null==e?void 0:e.email)||(null==n?void 0:n.email)||"",o=this.getBoltClientOrThrow();try{return yield o.hasBoltAccount(i)}catch(t){throw new y}})}setBoltOrderId(){return _(this,void 0,void 0,function*(){const t=this.paymentIntegrationService.getState().getOrderOrThrow(),e=this.getBoltClientOrThrow();try{yield e.setOrderId(t.orderId)}catch(t){throw new y}})}mountBoltEmbeddedField(t){const e=this.getBoltEmbeddedOrThrow().create("payment_field",{styles:{backgroundColor:"#fff"},renderSeparateFields:!0});e.mount(`#${t}`),this.embeddedField=e}validateTokenizeResultOrThrow(t){if(!t)throw new y;if(t instanceof Error)throw new x(t.message);const{token:e,last4:n,bin:i,expiration:o}=t,r=+n,a=+i,s=+`${o}`.split("-")[1],d=+`${o}`.split("-")[0];if(!e||Number.isNaN(r)||Number.isNaN(a)||Number.isNaN(s)||Number.isNaN(d))throw new k;return t}setExtraItemsForAnalytics(){const t=this.paymentIntegrationService.getState(),e=t.getStoreConfigOrThrow(),n=t.getCartOrThrow();if(e.checkoutSettings.isAnalyticsEnabled&&function(t){return Boolean(t.hasOwnProperty("analytics"))}(window)){const{id:t,lineItems:e}=n;this.analyticsExtraItemsManager.saveExtraItemsData(t,e)}}}const T=d(e=>new U(e,new P(t()),new S(n)),[{id:"bolt"}]);class N extends c{constructor(t){super(t||"Not implemented."),this.name="NotImplementedError",this.type="not_implemented"}}class A{constructor(t,e,n=window){this.paymentIntegrationService=t,this.boltScriptLoader=e,this.boltHostWindow=n}initialize(t){return e=this,n=void 0,o=function*(){const{bolt:e,containerId:n,methodId:i}=t,{buyNowInitializeOptions:o,style:r}=e||{};if(!i)throw new l('Unable to initialize payment because "options.methodId" argument is not provided.');if(!n)throw new l('Unable to initialize payment because "options.containerId" argument is not provided.');if(!e)throw new l('Unable to initialize payment because "options.bolt" argument is not provided.');if(!Boolean(o))throw new N("Only buy now flow is implemented for Bolt button");if(!(null==o?void 0:o.storefrontApiToken)||"string"!=typeof o.storefrontApiToken)throw new l('Unable to initialize payment because "options.storefrontApiToken" argument is not provided.');const a=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(i),{initializationData:s,config:d}=a,{publishableKey:c,developerConfig:u}=s||{};yield this.boltScriptLoader.loadBoltClient(c,d.testMode,u,"BigCommerce",o.storefrontApiToken),this.renderButton(n,a,r)},new((i=void 0)||(i=Promise))(function(t,r){function a(t){try{d(o.next(t))}catch(t){r(t)}}function s(t){try{d(o.throw(t))}catch(t){r(t)}}function d(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i(function(t){t(n)})).then(a,s)}d((o=o.apply(e,n||[])).next())});var e,n,i,o}deinitialize(){return Promise.resolve()}renderButton(t,e,n){var i;"function"==typeof(null===(i=this.boltHostWindow.BoltConnect)||void 0===i?void 0:i.setupProductPageCheckout)&&(this.addButtonContainer(t,e,n),this.boltHostWindow.BoltConnect.setupProductPageCheckout())}addButtonContainer(t,e,n){const i=document.getElementById(t);if(!i)return;const o=document.createElement("div"),r=document.createElement("object");o.setAttribute("id","product-page-checkout-wrapper"),o.setAttribute("class","bolt-button-wrapper"),o.setAttribute("style","display:none"),o.setAttribute("data-tid","product-page-checkout-wrapper"),r.setAttribute("data",this.getBoltObjectData(e,n)),r.setAttribute("class","bolt-product-checkout-button"),o.append(r),i.innerHTML="",i.append(o)}getBoltObjectData(t,e){const{initializationData:n,config:i}=t,{publishableKey:r,developerConfig:a}=n||{},s=this.boltScriptLoader.getDomainURL(!!i.testMode,a),d=this.getButtonHeight(null==e?void 0:e.size),c=this.getButtonBorderRadius(null==e?void 0:e.shape,d);return o({url:`https://${s}/v1/checkout_button`,query:{publishable_key:r,variant:"ppc",height:d,border_radius:c}})}getButtonHeight(t){if(t)switch(t){case f.Small:return 25;case f.Large:return 45;case f.Medium:default:return 40}}getButtonBorderRadius(t,e){if(t)switch(t){case v.Pill:return e?Math.round(e/2):void 0;case v.Rect:default:return 4}}}const D=d(e=>new A(e,new P(t())),[{id:"bolt"}]);export{D as createBoltButtonStrategy,B as createBoltCustomerStrategy,T as createBoltPaymentStrategy};
//# sourceMappingURL=bolt.js.map