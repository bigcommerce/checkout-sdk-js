import{getScriptLoader as t}from"@bigcommerce/script-loader";import{default as e}from"local-storage-fallback";import{isObject as n}from"lodash";import{noop as i}from"rxjs";import{stringifyUrl as o}from"query-string";class r{constructor(t){this.storage=t}saveExtraItemsData(t,e){const n=[...e.physicalItems,...e.digitalItems].reduce((t,e)=>(t[e.productId]={brand:e.brand?e.brand:"",category:e.categoryNames?e.categoryNames.join(", "):""},t),{});try{return this.storage.setItem(this.getStorageKey(t),JSON.stringify(n)),n}catch(t){return{}}}readExtraItemsData(t){try{const e=this.storage.getItem(this.getStorageKey(t));if(!e)return null;const i=JSON.parse(e);return function(t){if(!n(t))return!1;const e=Object.values(t).some(t=>!n(t)||!("brand"in t)||!("category"in t));return Boolean(!e)}(i)?i:null}catch(t){return null}}clearExtraItemData(t){try{this.storage.removeItem(this.getStorageKey(t))}catch(t){}}getStorageKey(t){return t?`ORDER_ITEMS_${t}`:""}}function a(t,e){return Object.assign(t,{resolveIds:e})}class s extends Error{constructor(t){var e;super(t||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",e=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,e):this.__proto__=e,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class d extends s{constructor(t){super(t||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}var c;!function(t){t[t.MissingBillingAddress=0]="MissingBillingAddress",t[t.MissingCart=1]="MissingCart",t[t.MissingCheckout=2]="MissingCheckout",t[t.MissingConsignments=3]="MissingConsignments",t[t.MissingCustomer=4]="MissingCustomer",t[t.MissingCheckoutConfig=5]="MissingCheckoutConfig",t[t.MissingOrder=6]="MissingOrder",t[t.MissingOrderConfig=7]="MissingOrderConfig",t[t.MissingOrderId=8]="MissingOrderId",t[t.MissingPayment=9]="MissingPayment",t[t.MissingPaymentId=10]="MissingPaymentId",t[t.MissingPaymentInstrument=11]="MissingPaymentInstrument",t[t.MissingPaymentMethod=12]="MissingPaymentMethod",t[t.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",t[t.MissingPaymentStatus=14]="MissingPaymentStatus",t[t.MissingPaymentToken=15]="MissingPaymentToken",t[t.MissingShippingAddress=16]="MissingShippingAddress"}(c||(c={}));class l extends s{constructor(t){super(function(t){switch(t){case c.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case c.MissingCart:return"Unable to proceed because cart data is unavailable.";case c.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case c.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case c.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case c.MissingCheckoutConfig:case c.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case c.MissingOrder:return"Unable to proceed because order data is unavailable.";case c.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case c.MissingPayment:return"Unable to proceed because payment data is unavailable.";case c.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case c.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case c.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(t)),this.subtype=t,this.name="MissingDataError",this.type="missing_data"}}class u extends s{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}class h extends d{constructor(t){let e="Unable to submit payment for the order because the payload is invalid.";t&&(e=`${e} Make sure the following fields are provided correctly: ${t.join(", ")}.`),super(e),this.name="PaymentArgumentInvalidError"}}class m extends s{constructor(t){super(t||"Unable to proceed because the client library of a payment method has thrown an unexpected error."),this.name="PaymentMethodFailedError",this.type="payment_method_client_invalid"}}class p extends s{constructor(t){super(t||"Payment process was cancelled."),this.name="PaymentMethodCancelledError",this.type="payment_cancelled"}}function g(t){return"object"==typeof t&&null!==t&&"shouldCreateAccount"in t}const y={body:{},headers:{},status:0};class b extends s{constructor(t,{message:e,errors:n}={}){const{body:i,headers:o,status:r}=t||y;super(e||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=i,this.headers=o,this.status=r,this.errors=n||[]}}class f extends b{constructor(t){super(t,{message:"There is a problem processing your payment. Please try again later."}),this.name="PaymentMethodInvalidError",this.type="payment_method_invalid"}}var v;!function(t){t[t.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",t[t.CustomerNotInitialized=1]="CustomerNotInitialized",t[t.PaymentNotInitialized=2]="PaymentNotInitialized",t[t.ShippingNotInitialized=3]="ShippingNotInitialized",t[t.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(v||(v={}));class w extends s{constructor(t){super(function(t){switch(t){case v.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case v.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case v.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case v.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(t)),this.subtype=t,this.name="NotInitializedError",this.type="not_initialized"}}class C extends s{constructor(t){super(),this.errorCode=t,this.name="BoltPaymentsFieldError",this.type="bolt_payments_field_error",this.body={errors:[C.getError(t)]}}static getError(t){switch(t){case"1000":case"2000":case"3000":return{code:"invalid_number"};case"1001":case"2001":case"3001":return{code:"invalid_expiry_date"};case"1002":case"2002":return{code:"invalid_cvc"};case"1003":return{code:"invalid_zip"};case"2003":return{code:"incorrect_zip"};default:return{code:"general_error"}}}}var I,M,P,B=function(t,e,n,i){return new(n||(n=Promise))(function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}d((i=i.apply(t,e||[])).next())})};class S{constructor(t,e,n){this.paymentIntegrationService=t,this.boltScriptLoader=e,this.analyticsExtraItemsManager=n,this.useBoltClient=!1,this.useBoltEmbedded=!1}initialize(t){return B(this,void 0,void 0,function*(){const{bolt:e,methodId:n}=t,{containerId:i,onPaymentSelect:o,useBigCommerceCheckout:r}=e||{};if(!n)throw new d('Unable to initialize payment because "options.methodId" argument is not provided.');if(!r)return void(this.boltClient=yield this.boltScriptLoader.loadBoltClient());const a=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(t.methodId),{initializationData:s,config:u}=a,{publishableKey:h,developerConfig:m,embeddedOneClickEnabled:p}=s||{},{testMode:g}=u;if(!h)throw new l(c.MissingPaymentMethod);if(this.boltClient=yield this.boltScriptLoader.loadBoltClient(h,g,m),this.useBoltClient=!p,this.useBoltEmbedded=!!p,this.useBoltEmbedded){if(!i)throw new d('Unable to initialize payment because "options.bolt.containerId" argument is not provided.');if(!o)throw new d('Unable to initialize payment because "options.bolt.onPaymentSelect" argument is not provided.');this.boltEmbedded=yield this.boltScriptLoader.loadBoltEmbedded(h,g,m),this.mountBoltEmbeddedField(i),o(yield this.hasBoltAccount())}})}deinitialize(){var t;return null===(t=this.embeddedField)||void 0===t||t.unmount(),this.boltClient=void 0,this.boltEmbedded=void 0,Promise.resolve()}finalize(){return Promise.reject(new u)}execute(t,e){return B(this,void 0,void 0,function*(){this.setExtraItemsForAnalytics();const{payment:i}=t,o=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(t);o<i.length;o++)e.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(t,i[o])&&(n[i[o]]=t[i[o]])}return n}(t,["payment"]),{methodId:r,paymentData:a}=i||{};let s;if(!t.payment)throw new h(["payment"]);if(!r)throw new l(c.MissingPaymentMethod);if(!a||!function(t){return Boolean(n(t)&&("shouldSaveInstrument"in t||"nonce"in t||g(t)))}(a))throw new l(c.MissingPayment);yield this.paymentIntegrationService.submitOrder(o,e),s=this.useBoltClient?yield this.getBoltClientPaymentPayload(r,a,e):this.useBoltEmbedded?yield this.getBoltEmbeddedPaymentPayload(r,a):yield this.getBoltFullCheckoutPaymentPayload(r,a),yield this.paymentIntegrationService.submitPayment(s)})}getBoltClientPaymentPayload(t,e,n){return B(this,void 0,void 0,function*(){yield this.paymentIntegrationService.loadPaymentMethod(t,n);const i=this.paymentIntegrationService.getState(),o=i.getPaymentMethodOrThrow(t).clientToken,{isStoreCreditApplied:r}=i.getCheckoutOrThrow(),{shouldSaveInstrument:a}=e,s=this.getBoltClientOrThrow();if(yield this.paymentIntegrationService.applyStoreCredit(r),!o)throw new l(c.MissingPaymentMethod);const d=yield new Promise((t,e)=>{const n={success:(n,i)=>{n.reference?t(n):e(new m("Unable to proceed because transaction reference is unavailable. Please try again later.")),i()},close:()=>{e(new p)}};s.configure({orderToken:o},{},n).open()});return{methodId:t,paymentData:{nonce:d.reference,shouldSaveInstrument:a}}})}getBoltEmbeddedPaymentPayload(t,e){var n;return B(this,void 0,void 0,function*(){if(!g(e))throw new l(c.MissingPayment);const i=this.validateTokenizeResultOrThrow(yield null===(n=this.embeddedField)||void 0===n?void 0:n.tokenize());return{methodId:t,paymentData:{formattedPayload:{credit_card_token:{token:i.token,last_four_digits:i.last4,iin:i.bin,expiration_month:+i.expiration.split("-")[1],expiration_year:+i.expiration.split("-")[0]},provider_data:{create_account:!!e.shouldCreateAccount,embedded_checkout:!0}}}}})}getBoltFullCheckoutPaymentPayload(t,e){return B(this,void 0,void 0,function*(){yield this.setBoltOrderId();const n=this.getBoltClientOrThrow(),i=yield n.getTransactionReference();if(!i)throw new f;return{methodId:t,paymentData:Object.assign(Object.assign({},e),{nonce:i})}})}getBoltClientOrThrow(){if(!this.boltClient)throw new w(v.PaymentNotInitialized);return this.boltClient}getBoltEmbeddedOrThrow(){if(!this.boltEmbedded)throw new w(v.PaymentNotInitialized);return this.boltEmbedded}hasBoltAccount(){return B(this,void 0,void 0,function*(){const t=this.paymentIntegrationService.getState(),e=t.getCustomer(),n=t.getBillingAddress(),i=(null==e?void 0:e.email)||(null==n?void 0:n.email)||"",o=this.getBoltClientOrThrow();try{return yield o.hasBoltAccount(i)}catch(t){throw new f}})}setBoltOrderId(){return B(this,void 0,void 0,function*(){const t=this.paymentIntegrationService.getState().getOrderOrThrow(),e=this.getBoltClientOrThrow();try{yield e.setOrderId(t.orderId)}catch(t){throw new f}})}mountBoltEmbeddedField(t){const e=this.getBoltEmbeddedOrThrow().create("payment_field",{styles:{backgroundColor:"#fff"},renderSeparateFields:!0});e.mount(`#${t}`),this.embeddedField=e}validateTokenizeResultOrThrow(t){if(!t)throw new f;if(t instanceof Error)throw new C(t.message);const{token:e,last4:n,bin:i,expiration:o}=t,r=+n,a=+i,s=+`${o}`.split("-")[1],d=+`${o}`.split("-")[0];if(!e||Number.isNaN(r)||Number.isNaN(a)||Number.isNaN(s)||Number.isNaN(d))throw new h;return t}setExtraItemsForAnalytics(){const t=this.paymentIntegrationService.getState(),e=t.getStoreConfigOrThrow(),n=t.getCartOrThrow();if(e.checkoutSettings.isAnalyticsEnabled&&function(t){return Boolean(t.hasOwnProperty("analytics"))}(window)){const{id:t,lineItems:e}=n;this.analyticsExtraItemsManager.saveExtraItemsData(t,e)}}}class O extends s{constructor(t){super(t||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}!function(t){t.SandboxMode="bolt_sandbox",t.StagingMode="bolt_staging",t.DevelopmentMode="bolt_development"}(I||(I={})),function(t){t.Small="small",t.Medium="medium",t.Large="large"}(M||(M={})),function(t){t.Pill="pill",t.Rect="rect"}(P||(P={}));var k=function(t,e,n,i){return new(n||(n=Promise))(function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}d((i=i.apply(t,e||[])).next())})};class E{constructor(t,e=window){this.scriptLoader=t,this.boltHostWindow=e}loadBoltClient(t,e,n,i,o){return k(this,void 0,void 0,function*(){if(this.boltHostWindow.BoltCheckout)return this.boltHostWindow.BoltCheckout;if(!t)throw new d('Unable to initialize payment because "publishableKey" argument is not provided.');if(yield this.scriptLoader.loadScript(`//${this.getDomainURL(!!e,n)}/connect-bigcommerce.js`,this.getScriptOptions("bolt-connect",t,i,o)),yield this.scriptLoader.loadScript(`//${this.getDomainURL(!!e,n)}/track.js`,this.getScriptOptions("bolt-track",t)),!this.boltHostWindow.BoltCheckout)throw new O;return this.boltHostWindow.BoltCheckout})}loadBoltEmbedded(t,e,n){return k(this,void 0,void 0,function*(){if(yield this.scriptLoader.loadScript(`//${this.getDomainURL(!!e,n)}/embed.js`,{async:!0,attributes:{id:"bolt-embedded"}}),!this.boltHostWindow.Bolt)throw new O;return this.boltHostWindow.Bolt(t)})}getDomainURL(t,e){if(!t)return"connect.bolt.com";if(e)switch(e.developerMode){case I.StagingMode:return"connect-staging.bolt.com";case I.DevelopmentMode:return`connect.${e.developerDomain}`}return"connect-sandbox.bolt.com"}getScriptOptions(t,e,n,i){return{async:!0,attributes:Object.assign(Object.assign({id:t,"data-publishable-key":e},n&&{"data-shopping-cart-id":n}),i&&{"data-storefront-api-token":i})}}}const z=a(n=>new S(n,new E(t()),new r(e)),[{id:"bolt"}]);var x=function(t,e,n,i){return new(n||(n=Promise))(function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}d((i=i.apply(t,e||[])).next())})};class _{constructor(t,e){this.paymentIntegrationService=t,this.boltScriptLoader=e,this.boltHostWindow=window}initialize(t){var e;return x(this,void 0,void 0,function*(){const{methodId:n,bolt:i}=t,{onInit:o}=i||{};if(!n)throw new d('Unable to proceed because "methodId" argument is not provided.');yield this.paymentIntegrationService.loadPaymentMethod(n);const r=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(n);if(!(null===(e=r.initializationData)||void 0===e?void 0:e.publishableKey))throw new l(c.MissingPaymentMethod);const{developerConfig:a,publishableKey:s}=r.initializationData;if(yield this.boltScriptLoader.loadBoltClient(s,r.config.testMode,a),o&&"function"==typeof o){const t=this.getCustomerEmail();o(yield this.hasBoltAccount(t),t)}})}deinitialize(){return Promise.resolve()}signIn(t,e){return x(this,void 0,void 0,function*(){return yield this.paymentIntegrationService.signInCustomer(t,e),Promise.resolve()})}signOut(t){return x(this,void 0,void 0,function*(){return yield this.paymentIntegrationService.signOutCustomer(t),Promise.resolve()})}executePaymentMethodCheckout(t){return x(this,void 0,void 0,function*(){const{continueWithCheckoutCallback:e=i,checkoutPaymentMethodExecuted:n,methodId:o}=t||{},r=this.getCustomerEmail();if(!o)throw new d('Unable to proceed because "methodId" argument is not provided.');if("function"!=typeof e)throw new d('Unable to proceed because "continueWithCheckoutCallback" argument is not provided and it must be a function.');if(r)return this.openBoltCheckoutModalOrThrow(r,o,e,n);e()})}openBoltCheckoutModalOrThrow(t,e,n,i){var o;return x(this,void 0,void 0,function*(){const r=this.getBoltClientOrThrow(),a=this.paymentIntegrationService.getState().getPaymentMethod(e);try{if(null===(o=null==a?void 0:a.initializationData)||void 0===o?void 0:o.embeddedOneClickEnabled){const e=yield this.hasBoltAccount(t);if(e){const e={close:()=>{n()}};yield r.openCheckout(t,e)}else n();"function"==typeof i&&i({hasBoltAccount:e})}else n()}catch(t){if(function(t){return"string"==typeof t.message&&"string"==typeof t.type&&("string"==typeof t.subtype||!t.subtype)&&t instanceof Error}(t)&&"MissingDataError"!==t.name&&"NotInitializedError"!==t.name)throw new m(t.message);throw t}})}getBoltClientOrThrow(){const t=this.boltHostWindow.BoltCheckout;if(!t)throw new w(v.PaymentNotInitialized);return t}hasBoltAccount(t){return x(this,void 0,void 0,function*(){const e=this.getBoltClientOrThrow();try{return yield e.hasBoltAccount(t)}catch(t){throw new f}})}getCustomerEmail(){const t=this.paymentIntegrationService.getState(),e=t.getCustomer(),n=t.getBillingAddress();return(null==e?void 0:e.email)||(null==n?void 0:n.email)||""}}const U=a(e=>new _(e,new E(t())),[{id:"bolt"}]);class T extends s{constructor(t){super(t||"Not implemented."),this.name="NotImplementedError",this.type="not_implemented"}}class N{constructor(t,e,n=window){this.paymentIntegrationService=t,this.boltScriptLoader=e,this.boltHostWindow=n}initialize(t){return e=this,n=void 0,o=function*(){const{bolt:e,containerId:n,methodId:i}=t,{buyNowInitializeOptions:o,style:r}=e||{};if(!i)throw new d('Unable to initialize payment because "options.methodId" argument is not provided.');if(!n)throw new d('Unable to initialize payment because "options.containerId" argument is not provided.');if(!e)throw new d('Unable to initialize payment because "options.bolt" argument is not provided.');if(!Boolean(o))throw new T("Only buy now flow is implemented for Bolt button");if(!(null==o?void 0:o.storefrontApiToken)||"string"!=typeof o.storefrontApiToken)throw new d('Unable to initialize payment because "options.storefrontApiToken" argument is not provided.');const a=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(i),{initializationData:s,config:c}=a,{publishableKey:l,developerConfig:u}=s||{};yield this.boltScriptLoader.loadBoltClient(l,c.testMode,u,"BigCommerce",o.storefrontApiToken),this.renderButton(n,a,r)},new((i=void 0)||(i=Promise))(function(t,r){function a(t){try{d(o.next(t))}catch(t){r(t)}}function s(t){try{d(o.throw(t))}catch(t){r(t)}}function d(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i(function(t){t(n)})).then(a,s)}d((o=o.apply(e,n||[])).next())});var e,n,i,o}deinitialize(){return Promise.resolve()}renderButton(t,e,n){var i;"function"==typeof(null===(i=this.boltHostWindow.BoltConnect)||void 0===i?void 0:i.setupProductPageCheckout)&&(this.addButtonContainer(t,e,n),this.boltHostWindow.BoltConnect.setupProductPageCheckout())}addButtonContainer(t,e,n){const i=document.getElementById(t);if(!i)return;const o=document.createElement("div"),r=document.createElement("object");o.setAttribute("id","product-page-checkout-wrapper"),o.setAttribute("class","bolt-button-wrapper"),o.setAttribute("style","display:none"),o.setAttribute("data-tid","product-page-checkout-wrapper"),r.setAttribute("data",this.getBoltObjectData(e,n)),r.setAttribute("class","bolt-product-checkout-button"),o.append(r),i.innerHTML="",i.append(o)}getBoltObjectData(t,e){const{initializationData:n,config:i}=t,{publishableKey:r,developerConfig:a}=n||{},s=this.boltScriptLoader.getDomainURL(!!i.testMode,a),d=this.getButtonHeight(null==e?void 0:e.size),c=this.getButtonBorderRadius(null==e?void 0:e.shape,d);return o({url:`https://${s}/v1/checkout_button`,query:{publishable_key:r,variant:"ppc",height:d,border_radius:c}})}getButtonHeight(t){if(t)switch(t){case M.Small:return 25;case M.Large:return 45;case M.Medium:default:return 40}}getButtonBorderRadius(t,e){if(t)switch(t){case P.Pill:return e?Math.round(e/2):void 0;case P.Rect:default:return 4}}}const A=a(e=>new N(e,new E(t())),[{id:"bolt"}]);export{A as createBoltButtonStrategy,U as createBoltCustomerStrategy,z as createBoltPaymentStrategy};
//# sourceMappingURL=bolt.js.map