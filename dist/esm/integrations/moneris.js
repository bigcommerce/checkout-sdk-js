import{isEmpty as e,map as t,omitBy as i}from"lodash";var n,s;class r extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class o extends r{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}!function(e){e[e.MissingBillingAddress=0]="MissingBillingAddress",e[e.MissingCart=1]="MissingCart",e[e.MissingCheckout=2]="MissingCheckout",e[e.MissingConsignments=3]="MissingConsignments",e[e.MissingCustomer=4]="MissingCustomer",e[e.MissingCheckoutConfig=5]="MissingCheckoutConfig",e[e.MissingOrder=6]="MissingOrder",e[e.MissingOrderConfig=7]="MissingOrderConfig",e[e.MissingOrderId=8]="MissingOrderId",e[e.MissingPayment=9]="MissingPayment",e[e.MissingPaymentId=10]="MissingPaymentId",e[e.MissingPaymentInstrument=11]="MissingPaymentInstrument",e[e.MissingPaymentMethod=12]="MissingPaymentMethod",e[e.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",e[e.MissingPaymentStatus=14]="MissingPaymentStatus",e[e.MissingPaymentToken=15]="MissingPaymentToken",e[e.MissingShippingAddress=16]="MissingShippingAddress"}(n||(n={}));class a extends r{constructor(e){super(function(e){switch(e){case n.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case n.MissingCart:return"Unable to proceed because cart data is unavailable.";case n.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case n.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case n.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case n.MissingCheckoutConfig:case n.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case n.MissingOrder:return"Unable to proceed because order data is unavailable.";case n.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case n.MissingPayment:return"Unable to proceed because payment data is unavailable.";case n.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case n.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case n.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(e)),this.subtype=e,this.name="MissingDataError",this.type="missing_data"}}class d extends o{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}class c extends r{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(s||(s={}));class l extends r{constructor(e){super(function(e){switch(e){case s.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case s.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case s.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case s.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}var u=function(e,t,i,n){return new(i||(i=Promise))(function(s,r){function o(e){try{d(n.next(e))}catch(e){r(e)}}function a(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(o,a)}d((n=n.apply(e,t||[])).next())})};const h="moneris-payment-iframe";class m{constructor(e){this.paymentIntegrationService=e}initialize(e){return u(this,void 0,void 0,function*(){const t=this.paymentIntegrationService.getState(),{moneris:i,methodId:s}=e;if(!s)throw new o('Unable to initialize payment because "methodId" argument is not provided.');if(!i)throw new o('Unable to initialize payment because "options.moneris" argument is not provided.');this.initializeOptions=i;const{config:r,initializationData:d}=t.getPaymentMethodOrThrow(s);if(!(null==d?void 0:d.profileId))throw new a(n.MissingPaymentMethod);return i.form&&this.shouldShowTSVHostedForm(s)&&(this.hostedForm=yield this.mountCardVerificationfields(i.form)),this.iframe||(this.iframe=this.createIframe(i.containerId,d,!!r.testMode)),Promise.resolve()})}execute(e,t){return u(this,void 0,void 0,function*(){const{payment:i}=e,n=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]])}return i}(e,["payment"]);if(!i)throw new d(["payment"]);const{isStoreCreditApplied:s}=this.paymentIntegrationService.getState().getCheckoutOrThrow();var r;if(s&&(yield this.paymentIntegrationService.applyStoreCredit(s)),yield this.paymentIntegrationService.submitOrder(n,t),!i.paymentData||(r=i.paymentData,!Boolean(r.instrumentId)))return this.executeWithCC(i);yield this.executeWithVaulted(i)})}finalize(){return Promise.reject(new c)}deinitialize(){return this.hostedForm&&this.hostedForm.detach(),this.windowEventListener&&(window.removeEventListener("message",this.windowEventListener),this.windowEventListener=void 0),this.iframe&&this.iframe.parentNode&&(this.iframe.parentNode.removeChild(this.iframe),this.iframe=void 0),Promise.resolve()}executeWithCC(e){return u(this,void 0,void 0,function*(){const t=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(e.methodId).config.testMode,i=e.paymentData||{},n="object"!=typeof(r=i)||null===r||void 0!==r.shouldSaveInstrument&&"boolean"!=typeof r.shouldSaveInstrument||void 0!==r.shouldSetAsDefaultInstrument&&"boolean"!=typeof r.shouldSetAsDefaultInstrument?{shouldSaveInstrument:!1,shouldSetAsDefaultInstrument:!1}:i;var r;const{shouldSaveInstrument:o,shouldSetAsDefaultInstrument:a}=n,d=yield new Promise((e,i)=>{if(!this.iframe)throw new l(s.PaymentNotInitialized);const n=this.iframe.contentWindow;if(null===n)throw new l(s.PaymentNotInitialized);n.postMessage("tokenize",this.monerisURL(!!t)),this.windowEventListener=n=>{if("string"==typeof n.data&&n.origin===`https://${t?"esqa":"www3"}.moneris.com`)try{e(this.handleMonerisResponse(n))}catch(e){i(e)}},window.addEventListener("message",this.windowEventListener)});void 0!==d&&(yield this.paymentIntegrationService.submitPayment({methodId:e.methodId,paymentData:{nonce:d,shouldSaveInstrument:o,shouldSetAsDefaultInstrument:a}}))})}executeWithVaulted(e){return u(this,void 0,void 0,function*(){if(this.hostedForm){const t=this.hostedForm;return yield t.validate(),yield t.submit(e),this.paymentIntegrationService.loadCurrentOrder()}return this.paymentIntegrationService.submitPayment(e)})}shouldShowTSVHostedForm(e){return this.isHostedPaymentFormEnabled(e)&&this.isHostedFieldAvailable()}isHostedPaymentFormEnabled(e){const t=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(e);return Boolean(t.config.isHostedFormEnabled)}isHostedFieldAvailable(){var t;const n=this.getInitializeOptions(),s=i(null===(t=n.form)||void 0===t?void 0:t.fields,e);return!e(s)}getInitializeOptions(){if(!this.initializeOptions)throw new l(s.PaymentNotInitialized);return this.initializeOptions}mountCardVerificationfields(e){var t;return u(this,void 0,void 0,function*(){const i=null===(t=this.paymentIntegrationService.getState().getStoreConfig())||void 0===t?void 0:t.paymentSettings.bigpayBaseUrl;if(!i)throw new a(n.MissingCheckoutConfig);const s=this.paymentIntegrationService.createHostedForm(i,e);return yield s.attach(),s})}createIframe(e,i,n,s){const r=document.getElementById(e);if(!r)throw new o("Unable to create iframe without valid container ID.");const a=document.createElement("iframe"),d={id:i.profileId,pmmsg:!0,display_labels:1,enable_exp:1,enable_cvd:1,css_body:(null==s?void 0:s.cssBody)||"font-family: Arial, Helvetica,sans-serif;background: transparent;",css_textbox:(null==s?void 0:s.cssTextbox)||"border-radius:4px;border: 2px solid rgb(00,00,00);width: 100%;font-weight: 600;padding: 8px 8px;outline: 0;",css_textbox_pan:(null==s?void 0:s.cssTextboxCardNumber)||"width: 240px;",css_textbox_exp:(null==s?void 0:s.cssTextboxExpiryDate)||"margin-bottom: 0;width: calc(30% - 12px);",css_textbox_cvd:(null==s?void 0:s.cssTextboxCVV)||"margin-bottom: 0;width: calc(30% - 12px);",css_input_label:(null==s?void 0:s.cssInputLabel)||"font-size: 10px;position: relative;top: 8px;left: 6px;background: rgb(255,255,255);padding: 3px 2px;color: rgb(66,66,66);font-weight: 600;z-index: 2;",pan_label:i.creditCardLabel||"Credit Card Number",exp_label:i.expiryDateLabel||"Expiration",cvd_label:i.cvdLabel||"CVD"},c=t(d,(e,t)=>`${t}=${e}`).join("&");return a.width="100%",a.height="100%",a.name=h,a.id=h,a.style.border="none",a.src=`${this.monerisURL(n)}?${c}`,a.allow="payment",r.appendChild(a),a}handleMonerisResponse(e){const t=JSON.parse(e.data);if("001"!==t.responseCode[0])throw new Error(t.errorMessage);return t.dataKey}monerisURL(e){return`https://${e?"esqa":"www3"}.moneris.com/HPPtoken/index.php`}}const p=(g=e=>new m(e),b=[{id:"moneris"}],Object.assign(g,{resolveIds:b}));var g,b;export{p as createMonerisPaymentStrategy};
//# sourceMappingURL=moneris.js.map