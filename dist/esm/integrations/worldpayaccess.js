import{isNil as e,merge as t,some as n,values as i}from"lodash";var o;class r extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class a extends r{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class s extends r{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}class d extends a{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(o||(o={}));class c extends r{constructor(e){super(function(e){switch(e){case o.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case o.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case o.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case o.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}var u=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function a(e){try{d(i.next(e))}catch(e){r(e)}}function s(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}d((i=i.apply(e,t||[])).next())})},l=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(n[i[o]]=e[i[o]])}return n};class m{constructor(e){this._paymentIntegrationService=e}execute(e,t){var n,i;return this._isHostedPaymentFormEnabled(null===(n=e.payment)||void 0===n?void 0:n.methodId,null===(i=e.payment)||void 0===i?void 0:i.gatewayId)&&this._shouldRenderHostedForm?this._executeWithHostedForm(e,t):this._executeWithoutHostedForm(e,t)}initialize(e){if(!this._isHostedPaymentFormEnabled(null==e?void 0:e.methodId,null==e?void 0:e.gatewayId)||!this._isHostedFieldAvailable(e))return this._shouldRenderHostedForm=!1,Promise.resolve();const t=e&&e.creditCard&&e.creditCard.form,n=this._paymentIntegrationService.getState(),{paymentSettings:{bigpayBaseUrl:i=""}={}}=n.getStoreConfigOrThrow();if(!t)throw new a;const o=this._paymentIntegrationService.createHostedForm(i,t);return o.attach().then(()=>(this._shouldRenderHostedForm=!0,this._hostedForm=o,Promise.resolve()))}deinitialize(){return this._hostedForm&&this._hostedForm.detach(),Promise.resolve()}finalize(){return Promise.reject(new s)}_executeWithoutHostedForm(e,t){return u(this,void 0,void 0,function*(){const{payment:n}=e,i=l(e,["payment"]),o=n&&n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this._paymentIntegrationService.submitOrder(i,t),yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:o}))})}_executeWithHostedForm(e,t){return u(this,void 0,void 0,function*(){const{payment:n}=e,i=l(e,["payment"]),r=this._hostedForm;if(!r)throw new c(o.PaymentNotInitialized);if(!n||!n.methodId)throw new d(["payment.methodId"]);yield this._paymentIntegrationService.submitOrder(i,t),yield r.validate().then(()=>r.submit(n))})}_isHostedPaymentFormEnabled(e,t){return!!e&&!0===this._paymentIntegrationService.getState().getPaymentMethodOrThrow(e,t).config.isHostedFormEnabled}_isHostedFieldAvailable(t){return!i(t&&t.creditCard&&t.creditCard.form.fields).every(e)}}const h=e=>"object"==typeof e&&null!==e&&"body"in e;var p=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function a(e){try{d(i.next(e))}catch(e){r(e)}}function s(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}d((i=i.apply(e,t||[])).next())})};const y="Payment cannot continue";let f;class v extends m{initialize(e){const t=Object.create(null,{initialize:{get:()=>super.initialize}});return p(this,void 0,void 0,function*(){if(this._initializeOptions=e&&e.worldpay,!this._initializeOptions)throw new c(o.PaymentNotInitialized);return t.initialize.call(this,e)})}execute(e,t){const n=Object.create(null,{execute:{get:()=>super.execute}});return p(this,void 0,void 0,function*(){const{payment:i}=e;if(f=this._submitAdditionalAction(),!i)throw new d(["payment"]);try{return yield n.execute.call(this,e,t)}catch(e){return this._processAdditionalAction(e,i)}})}_processAdditionalAction(e,i){return p(this,void 0,void 0,function*(){return h(e)&&n(e.body.errors,{code:"additional_action_required"})?new Promise((r,a)=>{const s=e=>p(this,void 0,void 0,function*(){if("string"!=typeof e.data||!this._isValidJsonWithSessionId(e.data))return a(new Error(y));window.removeEventListener("message",s),d.remove();const u=JSON.parse(e.data),l=t({},i,{paymentData:{threeDSecure:{token:u.SessionId}}});try{r(yield f(l))}catch(e){if(!h(e)||!n(e.body.errors,{code:"three_d_secure_required"}))return a(e);if(!this._initializeOptions)return a(new c(o.PaymentNotInitialized));const{onLoad:t}=this._initializeOptions,i=this._createIframe(e.body.three_ds_result);try{t(i,()=>a(new Error("Payment was cancelled")))}catch(e){a(new Error(y))}}});let d;window.addEventListener("message",s);try{d=this._createHiddenIframe(e.body)}catch(e){throw window.removeEventListener("message",s),new Error(y)}}):Promise.reject(e)})}_createHiddenIframe(e){const t=document.createElement("iframe");if(document.body.appendChild(t),!t.contentWindow)throw new Error;t.id="worldpay_hosted_hidden_payment_page",t.height="0px",t.width="0px";const n=document.createElement("form"),i="collectionForm";n.id=i,n.name="devicedata",n.method="post";const o=e.additional_action_required.data.redirect_url;n.action=o;const r=document.createElement("input");r.name="Bin",r.type="hidden",r.value=e.provider_data.source_id,n.appendChild(r);const a=document.createElement("input");a.name="JWT",a.type="hidden",a.value=e.provider_data.data,n.appendChild(a);const s=document.createElement("button");s.type="submit",s.id="btnsubmit",n.appendChild(s),navigator.userAgent.match("Firefox")?t.srcdoc=n.outerHTML:t.contentWindow.document.body.appendChild(n);const d=document.createElement("script");return d.innerHTML=`\n            document.getElementById('${i}').submit();\n        `,t.contentWindow.document.body.appendChild(d),t}_createIframe(e){const t=document.createElement("form");t.id="challengeForm",t.method="POST",t.action=e.acs_url;const n=document.createElement("input");n.name="JWT",n.type="hidden",n.value=e.payer_auth_request,t.appendChild(n);const i=document.createElement("input");i.name="MD",i.type="hidden",i.value=`merchantSessionId=${e.merchant_data}`,t.appendChild(i);const o=document.createElement("script");o.type="text/javascript",o.innerHTML="window.onload = function() { document.getElementById('challengeForm').submit(); }";const r=document.createElement("iframe");return r.name="worldpay_hosted_payment_page",r.height="400",r.width="100%",r.srcdoc=`${t.outerHTML} ${o.outerHTML}`,r}_submitAdditionalAction(){if(this._shouldRenderHostedForm){if(!this._hostedForm)throw new c(o.PaymentNotInitialized);const e=this._hostedForm;return t=>p(this,void 0,void 0,function*(){yield e.submit(t)})}return e=>p(this,void 0,void 0,function*(){yield this._paymentIntegrationService.submitPayment(e)})}_isValidJsonWithSessionId(e){try{return!!JSON.parse(e).SessionId}catch(e){return!1}}}const _=(b=e=>new v(e),w=[{id:"worldpayaccess"}],Object.assign(b,{resolveIds:w}));var b,w;export{_ as createWorldpayAccessPaymentStrategy};
//# sourceMappingURL=worldpayaccess.js.map