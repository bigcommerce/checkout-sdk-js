import{createScriptLoader as e}from"@bigcommerce/script-loader";var t;class n extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}!function(e){e[e.MissingBillingAddress=0]="MissingBillingAddress",e[e.MissingCart=1]="MissingCart",e[e.MissingCheckout=2]="MissingCheckout",e[e.MissingConsignments=3]="MissingConsignments",e[e.MissingCustomer=4]="MissingCustomer",e[e.MissingCheckoutConfig=5]="MissingCheckoutConfig",e[e.MissingOrder=6]="MissingOrder",e[e.MissingOrderConfig=7]="MissingOrderConfig",e[e.MissingOrderId=8]="MissingOrderId",e[e.MissingPayment=9]="MissingPayment",e[e.MissingPaymentId=10]="MissingPaymentId",e[e.MissingPaymentInstrument=11]="MissingPaymentInstrument",e[e.MissingPaymentMethod=12]="MissingPaymentMethod",e[e.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",e[e.MissingPaymentStatus=14]="MissingPaymentStatus",e[e.MissingPaymentToken=15]="MissingPaymentToken",e[e.MissingShippingAddress=16]="MissingShippingAddress"}(t||(t={}));class i extends n{constructor(e){super(function(e){switch(e){case t.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case t.MissingCart:return"Unable to proceed because cart data is unavailable.";case t.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case t.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case t.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case t.MissingCheckoutConfig:case t.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case t.MissingOrder:return"Unable to proceed because order data is unavailable.";case t.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case t.MissingPayment:return"Unable to proceed because payment data is unavailable.";case t.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case t.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case t.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(e)),this.subtype=e,this.name="MissingDataError",this.type="missing_data"}}class a extends n{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class r extends a{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}class s extends n{constructor(e){super(e||"The current order could not be finalized successfully"),this.name="OrderFinalizationNotCompletedError",this.type="order_finalization_not_completed"}}var o;!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(o||(o={}));class c extends n{constructor(e){super(function(e){switch(e){case o.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case o.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case o.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case o.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}const d={body:{},headers:{},status:0};class u extends n{constructor(e,{message:t,errors:n}={}){const{body:i,headers:a,status:r}=e||d;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=i,this.headers=a,this.status=r,this.errors=n||[]}}var l=function(e,t,n,i){return new(n||(n=Promise))(function(a,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function o(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,o)}c((i=i.apply(e,t||[])).next())})};class p{constructor(e,t){this._paymentIntegrationService=e,this._afterpayScriptLoader=t}initialize(e){var n;return l(this,void 0,void 0,function*(){const a=this._paymentIntegrationService.getState(),r=a.getPaymentMethod(e.methodId,e.gatewayId),s=(null===(n=a.getCart())||void 0===n?void 0:n.currency.code)||"",o=this._mapCurrencyToISO2(s);if(!r)throw new i(t.MissingPaymentMethod);this._afterpaySdk=yield this._afterpayScriptLoader.load(r,o)})}deinitialize(){return this._afterpaySdk&&(this._afterpaySdk=void 0),Promise.resolve()}execute(e,t){var n;return l(this,void 0,void 0,function*(){if(!e.payment)throw new r(["payment.gatewayId","payment.methodId"]);const{gatewayId:i,methodId:a}=e.payment;if(!i||!a)throw new r(["payment.gatewayId","payment.methodId"]);const{useStoreCredit:s}=e;void 0!==s&&(yield this._paymentIntegrationService.applyStoreCredit(s)),yield this._loadPaymentMethod(i,a,t);const o=this._paymentIntegrationService.getState();yield this._paymentIntegrationService.validateCheckout(o.getCheckout(),t);const c=(null===(n=o.getCart())||void 0===n?void 0:n.currency.code)||"",d=this._mapCurrencyToISO2(c);return this._redirectToAfterpay(d,o.getPaymentMethod(a,i)),new Promise(()=>{})})}finalize(e){var n,a,r;return l(this,void 0,void 0,function*(){const o=this._paymentIntegrationService.getState(),c=o.getPaymentId(),d=o.getContextConfig();if(!c)throw new i(t.MissingCheckout);if(!(null==d?void 0:d.payment.token))throw new i(t.MissingCheckoutConfig);const u={methodId:c.providerId,paymentData:{nonce:d.payment.token}};yield this._paymentIntegrationService.submitOrder({},e);try{yield this._paymentIntegrationService.submitPayment(u)}catch(e){if(yield this._paymentIntegrationService.forgetCheckout(c.providerId),yield this._paymentIntegrationService.loadPaymentMethods(),(e=>"object"==typeof e&&null!==e&&"body"in e)(e))throw new s(null===(r=null===(a=null===(n=e.body)||void 0===n?void 0:n.errors)||void 0===a?void 0:a[0])||void 0===r?void 0:r.message)}})}_redirectToAfterpay(e,t){if(!this._afterpaySdk||!(null==t?void 0:t.clientToken))throw new c(o.PaymentNotInitialized);this._afterpaySdk.initialize({countryCode:e}),this._afterpaySdk.redirect({token:t.clientToken})}_mapCurrencyToISO2(e){return{AUD:"AU",NZD:"NZ",CAD:"CA",USD:"US"}[e]||"AU"}_loadPaymentMethod(e,t,n){var i;return l(this,void 0,void 0,function*(){try{return yield this._paymentIntegrationService.loadPaymentMethod(e,Object.assign(Object.assign({},n),{params:Object.assign(Object.assign({},null==n?void 0:n.params),{method:t})}))}catch(e){if(e instanceof u&&422===(null===(i=e.body)||void 0===i?void 0:i.status))throw new a("Afterpay can't process your payment for this order, please try another payment method");throw e}})}}class h extends n{constructor(e){super(e||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}var y,m;!function(e){e.PROD="//portal.afterpay.com/afterpay-async.js",e.SANDBOX="//portal-sandbox.afterpay.com/afterpay-async.js"}(y||(y={})),function(e){e.PROD="//portal.afterpay.com/afterpay-async.js",e.SANDBOX="//portal.sandbox.afterpay.com/afterpay-async.js"}(m||(m={}));class g{constructor(e){this._scriptLoader=e}load(e,t){return n=this,i=void 0,r=function*(){const n=e.config.testMode||!1,i=this._getScriptURI(t,n);return this._scriptLoader.loadScript(i).then(()=>{if(!function(e){return"AfterPay"in e}(window))throw new h;return window.AfterPay})},new((a=void 0)||(a=Promise))(function(e,t){function s(e){try{c(r.next(e))}catch(e){t(e)}}function o(e){try{c(r.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof a?n:new a(function(e){e(n)})).then(s,o)}c((r=r.apply(n,i||[])).next())});var n,i,a,r}_getScriptURI(e,t){return"US"===e?t?m.SANDBOX:m.PROD:t?y.SANDBOX:y.PROD}}const f=(b=t=>new p(t,new g(e())),v=[{gateway:"afterpay"},{id:"afterpay"}],Object.assign(b,{resolveIds:v}));var b,v;export{f as createAfterpayPaymentStrategy};
//# sourceMappingURL=afterpay.js.map