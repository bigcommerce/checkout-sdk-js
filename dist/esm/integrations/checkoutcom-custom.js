import{isNil as e,some as t,values as n}from"lodash";import{createFormPoster as r}from"@bigcommerce/form-poster";var o,i={};function a(e,t){return Object.assign(e,{resolveIds:t})}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);class c extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class s extends c{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class d extends s{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}class u extends c{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(o||(o={}));class m extends c{constructor(e){super(function(e){switch(e){case o.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case o.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case o.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case o.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}var y,l=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,c)}s((r=r.apply(e,t||[])).next())})},p=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};class h{constructor(e){this._paymentIntegrationService=e}execute(e,t){var n,r;return this._isHostedPaymentFormEnabled(null===(n=e.payment)||void 0===n?void 0:n.methodId,null===(r=e.payment)||void 0===r?void 0:r.gatewayId)&&this._shouldRenderHostedForm?this._executeWithHostedForm(e,t):this._executeWithoutHostedForm(e,t)}initialize(e){if(!this._isHostedPaymentFormEnabled(null==e?void 0:e.methodId,null==e?void 0:e.gatewayId)||!this._isHostedFieldAvailable(e))return this._shouldRenderHostedForm=!1,Promise.resolve();const t=e&&e.creditCard&&e.creditCard.form,n=this._paymentIntegrationService.getState(),{paymentSettings:{bigpayBaseUrl:r=""}={}}=n.getStoreConfigOrThrow();if(!t)throw new s;const o=this._paymentIntegrationService.createHostedForm(r,t);return o.attach().then(()=>(this._shouldRenderHostedForm=!0,this._hostedForm=o,Promise.resolve()))}deinitialize(){return this._hostedForm&&this._hostedForm.detach(),Promise.resolve()}finalize(){return Promise.reject(new u)}_executeWithoutHostedForm(e,t){return l(this,void 0,void 0,function*(){const{payment:n}=e,r=p(e,["payment"]),o=n&&n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this._paymentIntegrationService.submitOrder(r,t),yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:o}))})}_executeWithHostedForm(e,t){return l(this,void 0,void 0,function*(){const{payment:n}=e,r=p(e,["payment"]),i=this._hostedForm;if(!i)throw new m(o.PaymentNotInitialized);if(!n||!n.methodId)throw new d(["payment.methodId"]);yield this._paymentIntegrationService.submitOrder(r,t),yield i.validate().then(()=>i.submit(n))})}_isHostedPaymentFormEnabled(e,t){return!!e&&!0===this._paymentIntegrationService.getState().getPaymentMethodOrThrow(e,t).config.isHostedFormEnabled}_isHostedFieldAvailable(t){return!n(t&&t.creditCard&&t.creditCard.form.fields).every(e)}}!function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.FINALIZE="FINALIZE",e.INITIALIZE="INITIALIZE"}(y||(y={}));const f=y,b=e=>"object"==typeof e&&null!==e&&"body"in e;var v;!function(e){e.OffsiteRedirect="offsite_redirect"}(v||(v={}));class O extends h{constructor(e){super(e),this.paymentIntegrationService=e}finalize(e){const t=this.paymentIntegrationService.getState();return t.getOrder()&&t.getPaymentStatus()===f.FINALIZE&&this.paymentIntegrationService.finalizeOrder(e),Promise.reject(new u)}_executeWithHostedForm(e,t){return n=this,r=void 0,a=function*(){const{payment:n}=e,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["payment"]),i=this._hostedForm;if(!i)throw new m(o.PaymentNotInitialized);if(!n||!n.methodId)throw new d(["payment.methodId"]);try{yield i.validate(),yield this.paymentIntegrationService.submitOrder(r,t),yield i.submit(n)}catch(e){return this._processResponse(e)}this.paymentIntegrationService.loadCurrentOrder()},new((i=void 0)||(i=Promise))(function(e,t){function o(e){try{s(a.next(e))}catch(e){t(e)}}function c(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i(function(e){e(n)})).then(o,c)}s((a=a.apply(n,r||[])).next())});var n,r,i,a}_processResponse(e){if(!b(e))return Promise.reject(e);const t=e.body.additional_action_required;return t&&t.type===v.OffsiteRedirect?this._performRedirect(t):Promise.reject(e)}_performRedirect(e){return new Promise(()=>{window.location.replace(e.data.redirect_url)})}}class g extends O{_executeWithoutHostedForm(e,t){return n=this,r=void 0,i=function*(){const{payment:n}=e,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["payment"]),o=n&&n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this._paymentIntegrationService.submitOrder(r,t);try{yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:Object.assign(Object.assign({},o),{formattedPayload:this._createFormattedPayload(n.methodId,o)})}))}catch(e){return this._processResponse(e)}},new((o=void 0)||(o=Promise))(function(e,t){function a(e){try{s(i.next(e))}catch(e){t(e)}}function c(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(a,c)}s((i=i.apply(n,r||[])).next())});var n,r,o,i}_createFormattedPayload(e,t){if("fawry"===e&&"customerMobile"in t&&"customerEmail"in t){const e=t;return{customerMobile:e.customerMobile,customerEmail:e.customerEmail}}}}const w=a(e=>new g(e),[{gateway:"checkoutcom",id:"fawry"}]);function I(e){return b(e)&&t(e.body.errors,{code:"three_d_secure_required"})}var P=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,c)}s((r=r.apply(e,t||[])).next())})},_=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};class S extends h{constructor(e,t){super(e),this.paymentIntegrationService=e,this.formPoster=t}finalize(e){const t=this.paymentIntegrationService.getState();return t.getOrder()&&t.getPaymentStatus()===f.FINALIZE&&this.paymentIntegrationService.finalizeOrder(e),Promise.reject(new u)}_executeWithoutHostedForm(e,t){return P(this,void 0,void 0,function*(){const{payment:n}=e,r=_(e,["payment"]),o=n&&n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this.paymentIntegrationService.submitOrder(r,t);try{yield this.paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:o}))}catch(e){return I(e)?this._handleThreeDSecure(e):Promise.reject(e)}})}_executeWithHostedForm(e,t){return P(this,void 0,void 0,function*(){const{payment:n}=e,r=_(e,["payment"]),i=this._hostedForm;if(!i)throw new m(o.PaymentNotInitialized);if(!n||!n.methodId)throw new d(["payment.methodId"]);try{yield i.validate(),yield this.paymentIntegrationService.submitOrder(r,t),yield i.submit(n)}catch(e){return I(e)?this._handleThreeDSecure(e):Promise.reject(e)}this.paymentIntegrationService.loadCurrentOrder()})}_handleThreeDSecure(e){const{acs_url:t,payer_auth_request:n,callback_url:r,merchant_data:o}=e.body.three_ds_result;return new Promise(()=>this.formPoster.postForm(t,{PaReq:n||null,TermUrl:r||null,MD:o||null}))}}const j=a(e=>new S(e,r()),[{gateway:"checkoutcom",id:"credit_card"},{gateway:"checkoutcom",id:"card"}]);class x extends O{_executeWithoutHostedForm(e,t){return n=this,r=void 0,i=function*(){const{payment:n}=e,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["payment"]),o=null==n?void 0:n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this._paymentIntegrationService.submitOrder(r,t);try{yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:Object.assign(Object.assign({},o),{formattedPayload:this._createFormattedPayload(n.methodId,o)})}))}catch(e){return this._processResponse(e)}},new((o=void 0)||(o=Promise))(function(e,t){function a(e){try{s(i.next(e))}catch(e){t(e)}}function c(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(a,c)}s((i=i.apply(n,r||[])).next())});var n,r,o,i}_createFormattedPayload(e,t){const n={iban:"",bic:""},{iban:r,bic:o}="iban"in t&&"bic"in t?t:n;return"sepa"===e&&document&&(n.iban=r,n.bic=o),n}}const F=a(e=>new x(e),[{gateway:"checkoutcom",id:"sepa"}]);class z extends O{_executeWithoutHostedForm(e,t){return n=this,r=void 0,i=function*(){const{payment:n}=e,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["payment"]),o=null==n?void 0:n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this._paymentIntegrationService.submitOrder(r,t);try{yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:Object.assign(Object.assign({},o),{formattedPayload:this._createFormattedPayload(n.methodId,o)})}))}catch(e){return this._processResponse(e)}},new((o=void 0)||(o=Promise))(function(e,t){function a(e){try{s(i.next(e))}catch(e){t(e)}}function c(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(a,c)}s((i=i.apply(n,r||[])).next())});var n,r,o,i}_createFormattedPayload(e,t){if("ideal"===e&&"bic"in t)return{bic:t.bic}}}const E=a(e=>new z(e),[{gateway:"checkoutcom",id:"ideal"}]);const D=["boleto","oxxo","qpay","ideal"];class N extends O{_executeWithoutHostedForm(e,t){return n=this,r=void 0,i=function*(){const{payment:n}=e,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["payment"]),o=null==n?void 0:n.paymentData;if(!n||!o)throw new d(["payment.paymentData"]);yield this._paymentIntegrationService.submitOrder(r,t);try{yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},n),{paymentData:Object.assign(Object.assign({},o),{formattedPayload:this._createFormattedPayload(n.methodId,o)})}))}catch(e){return this._processResponse(e)}},new((o=void 0)||(o=Promise))(function(e,t){function a(e){try{s(i.next(e))}catch(e){t(e)}}function c(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(a,c)}s((i=i.apply(n,r||[])).next())});var n,r,o,i}_createFormattedPayload(e,t){const n={ccDocument:""},r="ccDocument"in t?t.ccDocument:"";return-1!==D.indexOf(e)&&r&&(n.ccDocument=r),n}}const C=a(e=>new N(e),[{gateway:"checkoutcom"}]);export{C as createCheckoutComAPMPaymentStrategy,j as createCheckoutComCreditCardPaymentStrategy,w as createCheckoutComFawryPaymentStrategy,E as createCheckoutComIdealPaymentStrategy,F as createCheckoutComSepaPaymentStrategy};
//# sourceMappingURL=checkoutcom-custom.js.map