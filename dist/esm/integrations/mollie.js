import{getScriptLoader as e}from"@bigcommerce/script-loader";import{each as t,some as i}from"lodash";var n,o;class s extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class a extends s{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}!function(e){e[e.MissingBillingAddress=0]="MissingBillingAddress",e[e.MissingCart=1]="MissingCart",e[e.MissingCheckout=2]="MissingCheckout",e[e.MissingConsignments=3]="MissingConsignments",e[e.MissingCustomer=4]="MissingCustomer",e[e.MissingCheckoutConfig=5]="MissingCheckoutConfig",e[e.MissingOrder=6]="MissingOrder",e[e.MissingOrderConfig=7]="MissingOrderConfig",e[e.MissingOrderId=8]="MissingOrderId",e[e.MissingPayment=9]="MissingPayment",e[e.MissingPaymentId=10]="MissingPaymentId",e[e.MissingPaymentInstrument=11]="MissingPaymentInstrument",e[e.MissingPaymentMethod=12]="MissingPaymentMethod",e[e.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",e[e.MissingPaymentStatus=14]="MissingPaymentStatus",e[e.MissingPaymentToken=15]="MissingPaymentToken",e[e.MissingShippingAddress=16]="MissingShippingAddress"}(n||(n={}));class r extends s{constructor(e){super(function(e){switch(e){case n.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case n.MissingCart:return"Unable to proceed because cart data is unavailable.";case n.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case n.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case n.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case n.MissingCheckoutConfig:case n.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case n.MissingOrder:return"Unable to proceed because order data is unavailable.";case n.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case n.MissingPayment:return"Unable to proceed because payment data is unavailable.";case n.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case n.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case n.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(e)),this.subtype=e,this.name="MissingDataError",this.type="missing_data"}}class d extends a{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}function l(){const{navigator:e}=window;let t;return t=e.language?e.language:e.userLanguage,{color_depth:window.screen.colorDepth||24,java_enabled:"function"==typeof e.javaEnabled&&e.javaEnabled(),language:t,screen_height:window.screen.height,screen_width:window.screen.width,time_zone_offset:(new Date).getTimezoneOffset().toString()}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(o||(o={}));class c extends s{constructor(e){super(function(e){switch(e){case o.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case o.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case o.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case o.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}var u,m=function(e,t,i,n){return new(i||(i=Promise))(function(o,s){function a(e){try{d(n.next(e))}catch(e){s(e)}}function r(e){try{d(n.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}d((n=n.apply(e,t||[])).next())})};!function(e){e.CREDIT_CARD="credit_card"}(u||(u={}));const h=["klarnapaylater","klarnasliceit"];class p{constructor(e,t){this.mollieScriptLoader=e,this.paymentIntegrationService=t}initialize(e){return m(this,void 0,void 0,function*(){const{mollie:i,methodId:o,gatewayId:s}=e;if(!i)throw new a('Unable to initialize payment because "options.mollie" argument is not provided.');if(!o||!s)throw new a('Unable to initialize payment because "methodId" and/or "gatewayId" argument is not provided.');const d=document.querySelectorAll(".mollie-components-controller");t(d,e=>e.remove());const l=this.paymentIntegrationService.getState(),c=l.getStoreConfigOrThrow();this.initializeOptions=i;const u=l.getPaymentMethodOrThrow(o,s),{config:{merchantId:m,testMode:h}}=u;if(this.locale=l.getLocale(),!m)throw new r(n.MissingPaymentMethod);return this.isCreditCard(o)&&i.form&&this.shouldShowTSVHostedForm(o,s)?this.hostedForm=yield this.mountCardVerificationfields(i.form):this.isCreditCard(o)&&(this.mollieClient=yield this.loadMollieJs(m,c.storeProfile.storeLanguage,h),this.mountElements()),this.unsubscribe=()=>{if(this.paymentIntegrationService.getState().isPaymentMethodInitialized({methodId:e.methodId,gatewayId:e.gatewayId})){const e=document.getElementById(`${s}-${o}-paragraph`);e&&e.remove(),i.disableButton(!1),this.loadPaymentMethodsAllowed(i,o,s)}},this.unsubscribe(),this.loadPaymentMethodsAllowed(i,o,s),Promise.resolve()})}execute(e,t){return m(this,void 0,void 0,function*(){const{payment:i}=e,n=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(i[n[o]]=e[n[o]])}return i}(e,["payment"]),o=null==i?void 0:i.paymentData;if(!i||!i.gatewayId||!o)throw new d(["payment","gatewayId","paymentData"]);try{return yield this.paymentIntegrationService.submitOrder(n,t),Boolean(o.instrumentId)?yield this.executeWithVaulted(i):this.isCreditCard(i.methodId)?yield this.executeWithCC(i):yield this.executeWithAPM(i)}catch(e){yield this.processAdditionalAction(e)}})}finalize(){return Promise.resolve()}deinitialize(e){if(this.unsubscribe&&this.unsubscribe(),this.hostedForm&&this.hostedForm.detach(),e&&e.methodId&&e.gatewayId&&!this.hostedForm){const t=document.getElementById(`${e.gatewayId}-${e.methodId}`);t&&t.remove()}else e&&e.methodId&&this.isCreditCard(e.methodId)&&this.cardHolderElement&&this.cardNumberElement&&this.verificationCodeElement&&this.expiryDateElement&&(this.cardHolderElement.unmount(),this.cardHolderElement=void 0,this.cardNumberElement.unmount(),this.cardNumberElement=void 0,this.verificationCodeElement.unmount(),this.verificationCodeElement=void 0,this.expiryDateElement.unmount(),this.expiryDateElement=void 0);return this.mollieClient=void 0,Promise.resolve()}executeWithCC(e){return m(this,void 0,void 0,function*(){const t=e.paymentData,{shouldSaveInstrument:i=!1,shouldSetAsDefaultInstrument:n=!1}="object"!=typeof(o=t)||null===o||void 0!==o.shouldSaveInstrument&&"boolean"!=typeof o.shouldSaveInstrument||void 0!==o.shouldSetAsDefaultInstrument&&"boolean"!=typeof o.shouldSetAsDefaultInstrument?{}:t;var o;const{token:s,error:a}=yield this.getMollieClient().createToken();if(a)return Promise.reject(a);const r={credit_card_token:{token:s},vault_payment_instrument:i,set_as_default_stored_instrument:n,browser_info:l(),shopper_locale:this.getShopperLocale()};yield this.paymentIntegrationService.submitPayment(Object.assign(Object.assign({},e),{paymentData:{formattedPayload:r}}))})}executeWithVaulted(e){return m(this,void 0,void 0,function*(){if(this.isHostedPaymentFormEnabled(e.methodId,e.gatewayId)){const t=this.hostedForm;if(!t)throw new c(o.PaymentNotInitialized);yield t.validate(),yield t.submit(e),yield this.paymentIntegrationService.loadCurrentOrder()}else yield this.paymentIntegrationService.submitPayment(e)})}executeWithAPM(e){return m(this,void 0,void 0,function*(){const t=e.paymentData,i=t&&"issuer"in t?t.issuer:"";yield this.paymentIntegrationService.submitPayment(Object.assign(Object.assign({},e),{paymentData:Object.assign(Object.assign({},t),{formattedPayload:{issuer:i,shopper_locale:this.getShopperLocale()}})}))})}isCreditCard(e){return e===u.CREDIT_CARD}shouldShowTSVHostedForm(e,t){return this.isHostedPaymentFormEnabled(e,t)&&this.isHostedFieldAvailable()}mountCardVerificationfields(e){return new Promise((t,i)=>m(this,void 0,void 0,function*(){try{const i=this.paymentIntegrationService.getState().getStoreConfig(),o=null==i?void 0:i.paymentSettings.bigpayBaseUrl;if(!o)throw new r(n.MissingCheckoutConfig);const s=this.paymentIntegrationService.createHostedForm(o,e);yield s.attach(),t(s)}catch(e){i(e)}}))}isHostedPaymentFormEnabled(e,t){const{getPaymentMethodOrThrow:i}=this.paymentIntegrationService.getState();return!0===i(e,t).config.isHostedFormEnabled}isHostedFieldAvailable(){var e;return!!(null===(e=this.getInitializeOptions().form)||void 0===e?void 0:e.fields)}processAdditionalAction(e){if(!(e=>"object"==typeof e&&null!==e&&"body"in e)(e))return Promise.reject(e);if(i(e.body.errors,{code:"additional_action_required"})){const{additional_action_required:{data:{redirect_url:t}}}=e.body;return new Promise(()=>window.location.replace(t))}return Promise.reject(e)}getInitializeOptions(){if(!this.initializeOptions)throw new c(o.PaymentNotInitialized);return this.initializeOptions}loadMollieJs(e,t,i=!1){return this.mollieClient?Promise.resolve(this.mollieClient):this.mollieScriptLoader.load(e,t,i)}getMollieClient(){if(!this.mollieClient)throw new c(o.PaymentNotInitialized);return this.mollieClient}getShopperLocale(){if(!this.locale)throw new c(o.PaymentNotInitialized);return this.locale}mountElements(){const{containerId:e,cardNumberId:t,cardCvcId:i,cardExpiryId:n,cardHolderId:o,styles:s}=this.getInitializeOptions();let a;e&&(a=document.getElementById(e)),setTimeout(()=>{if(!e||"none"!==(null==a?void 0:a.style.display)){const e=this.getMollieClient();this.cardHolderElement=e.createComponent("cardHolder",{styles:s}),this.cardHolderElement.mount(`#${o}`),this.cardNumberElement=e.createComponent("cardNumber",{styles:s}),this.cardNumberElement.mount(`#${t}`),this.verificationCodeElement=e.createComponent("verificationCode",{styles:s}),this.verificationCodeElement.mount(`#${i}`),this.expiryDateElement=e.createComponent("expiryDate",{styles:s}),this.expiryDateElement.mount(`#${n}`)}},0)}loadPaymentMethodsAllowed(e,t,i){var n;if(h.includes(t)){const o=null===(n=this.paymentIntegrationService.getState().getCartOrThrow().lineItems)||void 0===n?void 0:n.digitalItems;if(o&&o.length>0){const{containerId:n}=this.getInitializeOptions();if(n){const o=document.getElementById(n);if(o){const n=document.createElement("p");n.setAttribute("id",`${i}-${t}-paragraph`),e.unsupportedMethodMessage&&(n.innerText=e.unsupportedMethodMessage,o.appendChild(n),e.disableButton(!0))}}}}}}class g extends s{constructor(e){super(e||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}class y{constructor(e,t=window){this.scriptLoader=e,this.mollieHostWindow=t}load(e,t,i){return n=this,o=void 0,a=function*(){if(yield this.scriptLoader.loadScript("https://js.mollie.com/v1/mollie.js"),!function(e){return"Mollie"in e}(this.mollieHostWindow))throw new g;return this.mollieHostWindow.Mollie(e,{locale:t,testmode:i})},new((s=void 0)||(s=Promise))(function(e,t){function i(e){try{d(a.next(e))}catch(e){t(e)}}function r(e){try{d(a.throw(e))}catch(e){t(e)}}function d(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s(function(e){e(n)})).then(i,r)}d((a=a.apply(n,o||[])).next())});var n,o,s,a}}const b=(f=t=>new p(new y(e()),t),v=[{gateway:"mollie"},{gateway:"mollie",id:"applepay"}],Object.assign(f,{resolveIds:v}));var f,v;export{b as createMolliePaymentStrategy};
//# sourceMappingURL=mollie.js.map