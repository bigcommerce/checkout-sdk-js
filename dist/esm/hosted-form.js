import{createClient as e}from"@bigcommerce/bigpay-client";import{createRequestSender as t}from"@bigcommerce/request-sender";import{fromEvent as n}from"rxjs";import{filter as r,map as i,take as s}from"rxjs/operators";import{filter as a,find as o,flatMap as d,get as c,kebabCase as u,keyBy as l,map as p,max as m,pick as h,reduce as g,snakeCase as y,some as _,values as f}from"lodash";import{creditCardType as b,cvv as C,expirationDate as v,number as E}from"card-validator";import{object as O,string as I}from"yup";function P(e,t,n){if("function"!=typeof n.value)return n;let r=n.value;return{get(){const e=r.bind(this);return Object.defineProperty(this,t,Object.assign(Object.assign({},n),{value:e})),e},set(e){r=e}}}class w extends Error{constructor(e){super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",function(e,t){Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t}(this,new.target.prototype),"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class A extends w{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}function T(e){if(!/^(https?:)?\/\//.test(e))throw new A("The provided URL must be absolute.");const t=document.createElement("a");t.href=e;const n=t.port&&-1!==e.indexOf(`${t.hostname}:${t.port}`)?t.port:"";return{hash:t.hash,hostname:t.hostname,href:t.href,origin:`${t.protocol}//${t.hostname}${n?`:${n}`:""}`,pathname:t.pathname,port:n,protocol:t.protocol,search:t.search}}function S(e){return T(0===e.hostname.indexOf("www")?e.href:e.href.replace(e.hostname,`www.${e.hostname}`))}function x(e,t){return e.type===t}class N{constructor(e){this._sourceOrigins=[T(e).origin,S(T(e)).origin],this._isListening=!1,this._listeners={}}listen(){this._isListening||(this._isListening=!0,window.addEventListener("message",this._handleMessage))}stopListen(){this._isListening&&(this._isListening=!1,window.removeEventListener("message",this._handleMessage))}addListener(e,t){let n=this._listeners[e];n||(this._listeners[e]=n=[]),-1===n.indexOf(t)&&n.push(t)}removeListener(e,t){const n=this._listeners[e];if(!n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)}trigger(e,t){const n=this._listeners[e.type];n&&n.forEach(n=>t?n(e,t):n(e))}_handleMessage(e){if(-1===this._sourceOrigins.indexOf(e.origin)||!x(e.data,e.data.type))return;const t=e.data,{context:n}=t,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(t,["context"]);this.trigger(r,n)}}!function(e,t,n,r){var i,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,n,a):i(t,n))||a);s>3&&a&&Object.defineProperty(t,n,a)}([function(e,t,n){return t&&n?P(0,t,n):function(e){const t=class extends e{};return Object.getOwnPropertyNames(e.prototype).forEach(n=>{const r=Object.getOwnPropertyDescriptor(e.prototype,n);r&&"constructor"!==n&&Object.defineProperty(t.prototype,n,P(e.prototype,n,r))}),t}(e)}],N.prototype,"_handleMessage",null);class M{setNonce(e){this._nonce=e}getNonce(){return this._nonce}}let D;function V(){return D=D||new M,D}class L{constructor(e,t,n){this._targetWindow=t,this._context=n,this._targetOrigin="*"===e?"*":T(e).origin}post(e,t){const a=this._targetWindow;if(window===a)return;if(!a)throw new Error("Unable to post message because target window is not set.");const o=t&&n(window,"message").pipe(r(e=>e.origin===this._targetOrigin&&x(e.data,e.data.type)&&-1!==[t.successType,t.errorType].indexOf(e.data.type)),i(e=>{if(t.errorType===e.data.type)throw e.data;return e.data}),s(1)).toPromise();return a.postMessage(Object.assign(Object.assign({},e),{context:this._context}),this._targetOrigin),o}setTarget(e){this._targetWindow=e}setContext(e){this._context=e}}class R{constructor(e){this._client=e}submitPayment(e){return new Promise((t,n)=>{this._client.submitPayment(e,(e,r)=>{e?n(this._transformResponse(e)):t(this._transformResponse(r))})})}initializeOffsitePayment(e,t){return new Promise(()=>{this._client.initializeOffsitePayment(e,null,t)})}_transformResponse(e){return{headers:e.headers,body:e.data,status:e.status,statusText:e.statusText}}}function U(e,t){let n;return function(e){return void 0!==e.id}(e)?n=e.id:t&&t.length&&(n=t[0].id),{id:n,firstName:e.firstName,lastName:e.lastName,company:e.company,addressLine1:e.address1,addressLine2:e.address2,city:e.city,province:e.stateOrProvince,provinceCode:e.stateOrProvinceCode,postCode:e.postalCode,country:e.country,countryCode:e.countryCode,phone:e.phone,customFields:e.customFields}}class j{constructor(e){this._decimalPlaces=e}toInteger(e){return Math.round(e*Math.pow(10,this._decimalPlaces))}}const k=["per_item_discount","percentage_discount","per_total_discount","shipping_discount","free_shipping"];function F(e){return{code:e.code,discount:e.displayName,discountType:k.indexOf(e.couponType)}}function H(e){return{code:e.code,discountedAmount:e.used,remainingBalance:e.remaining,giftCertificate:{balance:e.balance,code:e.code,purchaseDate:e.purchaseDate}}}function q(e){const t=[];return(e||[]).forEach(e=>{(e.banners||[]).forEach(e=>{t.push({placeholders:[],discountType:null,message:"",messageHtml:e.text})})}),t}function B(e,t,n="id"){return Object.keys(e).reduce((r,i)=>[...r,...e[i].map(e=>"giftCertificates"===i?function(e,t){const n=new j(t);return{id:e.id,imageUrl:"",name:e.name,amount:e.amount,amountAfterDiscount:e.amount,discount:0,integerAmount:n.toInteger(e.amount),integerAmountAfterDiscount:n.toInteger(e.amount),integerUnitPrice:n.toInteger(e.amount),integerUnitPriceAfterDiscount:n.toInteger(e.amount),integerDiscount:0,quantity:1,sender:e.sender,recipient:e.recipient,type:"ItemGiftCertificateEntity",attributes:[],variantId:null}}(e,t):function(e,t,n,r="id"){const i=new j(n);return{id:e[r],imageUrl:e.imageUrl,amount:e.extendedListPrice,amountAfterDiscount:e.extendedSalePrice,discount:e.discountAmount,integerAmount:i.toInteger(e.extendedListPrice),integerAmountAfterDiscount:i.toInteger(e.extendedSalePrice),integerDiscount:i.toInteger(e.discountAmount),integerUnitPrice:i.toInteger(e.listPrice),integerUnitPriceAfterDiscount:i.toInteger(e.salePrice),downloadsPageUrl:e.downloadPageUrl,name:e.name,quantity:e.quantity,brand:e.brand,sku:e.sku,categoryNames:e.categoryNames,variantId:e.variantId,productId:e.productId,attributes:(e.options||[]).map(e=>({name:e.name,value:e.value})),addedByPromotion:e.addedByPromotion,type:t}}(e,function(e){switch(e){case"physicalItems":return"ItemPhysicalEntity";case"digitalItems":return"ItemDigitalEntity";case"giftCertificates":return"ItemGiftCertificateEntity";default:return""}}(i),t,n))],[])}function G(e){const t=e.cart.currency.decimalPlaces,n=new j(t);return{id:e.cart.id,items:B(e.cart.lineItems,t),currency:e.cart.currency.code,coupon:{discountedAmount:g(e.cart.coupons,(e,t)=>e+t.discountedAmount,0),coupons:e.cart.coupons.map(F)},discount:{amount:e.cart.discountAmount,integerAmount:n.toInteger(e.cart.discountAmount)},discountNotifications:q(e.promotions),giftCertificate:{totalDiscountedAmount:g(e.giftCertificates,(e,t)=>e+t.used,0),appliedGiftCertificates:l(e.giftCertificates.map(H),"code")},shipping:{amount:e.shippingCostTotal,integerAmount:n.toInteger(e.shippingCostTotal),amountBeforeDiscount:e.shippingCostBeforeDiscount,integerAmountBeforeDiscount:n.toInteger(e.shippingCostBeforeDiscount),required:_(e.cart.lineItems.physicalItems,e=>e.isShippingRequired)},subtotal:{amount:e.subtotal,integerAmount:n.toInteger(e.subtotal)},storeCredit:{amount:e.customer?e.customer.storeCredit:0},taxSubtotal:{amount:e.taxTotal,integerAmount:n.toInteger(e.taxTotal)},taxes:e.taxes,taxTotal:{amount:e.taxTotal,integerAmount:n.toInteger(e.taxTotal)},handling:{amount:e.handlingCostTotal,integerAmount:n.toInteger(e.handlingCostTotal)},grandTotal:{amount:e.grandTotal,integerAmount:n.toInteger(e.grandTotal)}}}var Y;!function(e){e.APPLEPAY="applepay",e.AMAZON_PAY_V2="amazonpay",e.BRAINTREE_PAYPAL="braintreepaypal",e.BRAINTREE_VENMO="braintreevenmo",e.BRAINTREE_PAYPAL_CREDIT="braintreepaypalcredit",e.GOOGLEPAY_ADYENV2="googlepayadyenv2",e.GOOGLEPAY_ADYENV3="googlepayadyenv3",e.GOOGLEPAY_AUTHORIZENET="googlepayauthorizenet",e.GOOGLEPAY_BNZ="googlepaybnz",e.GOOGLEPAY_BRAINTREE="googlepaybraintree",e.GOOGLEPAY_CHECKOUTCOM="googlepaycheckoutcom",e.GOOGLEPAY_CYBERSOURCEV2="googlepaycybersourcev2",e.GOOGLEPAY_ORBITAL="googlepayorbital",e.GOOGLEPAY_STRIPE="googlepaystripe",e.GOOGLEPAY_STRIPEUPE="googlepaystripeupe",e.GOOGLEPAY_WORLDPAYACCESS="googlepayworldpayaccess",e.MASTERPASS="masterpass",e.PAYPALEXPRESS="paypalexpress"}(Y||(Y={}));const $=Y;var z;!function(e){e[e.MissingBillingAddress=0]="MissingBillingAddress",e[e.MissingCart=1]="MissingCart",e[e.MissingCheckout=2]="MissingCheckout",e[e.MissingConsignments=3]="MissingConsignments",e[e.MissingCustomer=4]="MissingCustomer",e[e.MissingCheckoutConfig=5]="MissingCheckoutConfig",e[e.MissingOrder=6]="MissingOrder",e[e.MissingOrderConfig=7]="MissingOrderConfig",e[e.MissingOrderId=8]="MissingOrderId",e[e.MissingPayment=9]="MissingPayment",e[e.MissingPaymentId=10]="MissingPaymentId",e[e.MissingPaymentInstrument=11]="MissingPaymentInstrument",e[e.MissingPaymentMethod=12]="MissingPaymentMethod",e[e.MissingPaymentProviderCustomer=13]="MissingPaymentProviderCustomer",e[e.MissingPaymentRedirectUrl=14]="MissingPaymentRedirectUrl",e[e.MissingPaymentStatus=15]="MissingPaymentStatus",e[e.MissingPaymentToken=16]="MissingPaymentToken",e[e.MissingShippingAddress=17]="MissingShippingAddress"}(z||(z={}));class W extends w{constructor(e){super(function(e){switch(e){case z.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case z.MissingCart:return"Unable to proceed because cart data is unavailable.";case z.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case z.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case z.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case z.MissingCheckoutConfig:case z.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case z.MissingOrder:return"Unable to proceed because order data is unavailable.";case z.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case z.MissingPayment:return"Unable to proceed because payment data is unavailable.";case z.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case z.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case z.MissingPaymentProviderCustomer:return"Unable to proceed because payment provider customer is unavailable.";case z.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(e)),this.subtype=e,this.name="MissingDataError",this.type="missing_data"}}function Q(e,t){const n=e.firstName||t.firstName||"",r=e.lastName||t.lastName||"";return{addresses:(e.addresses||[]).map(e=>U(e)),customerId:e.id,isGuest:e.isGuest,storeCredit:e.storeCredit,email:e.email||t.email||"",firstName:n,lastName:r,name:e.fullName||[n,r].join(" "),customerGroupName:e.customerGroup&&e.customerGroup.name}}class Z{format(e){const[t="",n=""]=e.split(new RegExp("\\s*/\\s*")),r=t.slice(0,2),i=4===n.length?n.slice(-2):n?n.slice(0,2):t.slice(2);return e.length<2?t:e.length>3&&!i?r:`${r} / ${i}`}toObject(e){const[t="",n=""]=e.split(new RegExp("\\s*/\\s*"));return/^\d+$/.test(t)&&/^\d+$/.test(n)?{month:1===t.length?`0${t}`:t.slice(0,2),year:2===n.length?`20${n}`:n.slice(0,4)}:{month:"",year:""}}}class J{format(e){const{card:t}=E(e);if(!t)return e;const n=m(b(e).map(e=>m(e.lengths))),r=this.unformat(e).slice(0,n);return t.gaps.filter(e=>r.length>e).reduce((e,t,n)=>[e.slice(0,t+n),e.slice(t+n)].join(" "),r)}unformat(e){const{card:t}=E(e);return t?e.replace(new RegExp(" ","g"),""):e}}function K(e,t={}){const n=e.currency.decimalPlaces,r=new j(n);return{id:e.orderId,items:B(e.lineItems,e.currency.decimalPlaces,"productId"),orderId:e.orderId,currency:e.currency.code,customerCanBeCreated:e.customerCanBeCreated,payment:te(e.payments,t.payment),subtotal:{amount:e.baseAmount,integerAmount:r.toInteger(e.baseAmount)},coupon:{discountedAmount:g(e.coupons,(e,t)=>e+t.discountedAmount,0),coupons:e.coupons.map(F)},discount:{amount:e.discountAmount,integerAmount:r.toInteger(e.discountAmount)},token:t.orderToken,callbackUrl:t.callbackUrl,discountNotifications:[],giftCertificate:ee(e.payments),socialData:re(e),status:e.status,hasDigitalItems:e.hasDigitalItems,isDownloadable:e.isDownloadable,isComplete:e.isComplete,shipping:{amount:e.shippingCostTotal,integerAmount:r.toInteger(e.shippingCostTotal),amountBeforeDiscount:e.shippingCostBeforeDiscount,integerAmountBeforeDiscount:r.toInteger(e.shippingCostBeforeDiscount)},storeCredit:{amount:X(e.payments)},taxes:e.taxes,taxTotal:{amount:e.taxTotal,integerAmount:r.toInteger(e.taxTotal)},handling:{amount:e.handlingCostTotal,integerAmount:r.toInteger(e.handlingCostTotal)},grandTotal:{amount:e.orderAmount,integerAmount:e.orderAmountAsInteger}}}function X(e){const t=o(e,{providerId:"storecredit"});return t?t.amount:0}function ee(e){const t=a(e,{providerId:"giftcertificate"});return{totalDiscountedAmount:g(t,(e,t)=>t.amount+e,0),appliedGiftCertificates:l(t.map(e=>({code:e.detail.code,discountedAmount:e.amount,remainingBalance:e.detail.remaining,giftCertificate:{balance:e.amount+e.detail.remaining,code:e.detail.code,purchaseDate:""}})),"code")}}function te(e,t={}){const n=o(e,ne);return n?{id:n.providerId,status:(r=n.detail.step,`PAYMENT_STATUS_${r}`),helpText:n.detail.instructions,returnUrl:t.returnUrl}:{};var r}function ne(e){return"giftcertificate"!==e.providerId&&"storecredit"!==e.providerId}function re(e){const t={};return[...e.lineItems.physicalItems,...e.lineItems.digitalItems].forEach(e=>{var n;t[e.id]=(n=e,["fb","tw","gp"].reduce((e,t)=>{const r=n.socialMedia&&o(n.socialMedia,e=>e.code===t);return r?(e[t]={name:n.name,description:n.name,image:n.imageUrl,url:r.link,shareText:r.text,sharingLink:r.link,channelName:r.channel,channelCode:r.code},e):e},{}))}),t}function ie(e,t){return{description:e.description,module:e.type,price:e.cost,id:e.id,selected:t,isRecommended:e.isRecommended,imageUrl:e.imageUrl,transitTime:e.transitTime}}class se{constructor(){this._cardExpiryFormatter=new Z,this._cardNumberFormatter=new J}transform(e,t){const n=t.billingAddress.getBillingAddress(),r=t.checkout.getCheckout(),i=t.customer.getCustomer(),s=t.order.getOrder(),a=t.paymentMethods.getPaymentMethod(e.methodId,e.gatewayId),o=this._mapShippingAddress(t,a),d=t.consignments.getConsignments(),c=t.consignments.getShippingOption(),u=t.config.getStoreConfig(),l=t.config.getContextConfig(),p=t.instruments.getInstrumentsMeta(),m=t.paymentMethods.getPaymentMethodsMeta(),g=t.order.getOrderMeta(),y=i&&n&&Q(i,n),_=p&&e.paymentData&&(f=e.paymentData,Boolean(f.instrumentId)||function(e){const t=e.formattedPayload;return!!t&&("string"==typeof t.bigpay_token||Boolean(t.bigpay_token&&t.bigpay_token.token))}(e.paymentData))?`${t.payment.getPaymentToken()}, ${p.vaultAccessToken}`:t.payment.getPaymentToken();var f;if(!_)throw new W(z.MissingPaymentToken);return{additionalAction:e.additionalAction,authToken:_,customer:y,billingAddress:n&&U(n),shippingAddress:o&&U(o,d),shippingOption:c&&ie(c,!0),cart:r&&G(r),order:s&&K(s,g),orderMeta:g,payment:e.paymentData,paymentMethod:a&&this._transformPaymentMethod(a),quoteMeta:{request:Object.assign(Object.assign({},m),{geoCountryCode:l&&l.geoCountryCode})},source:"bigcommerce-checkout-js-sdk",store:h(u&&u.storeProfile,["storeHash","storeId","storeLanguage","storeName"])}}transformWithHostedFormData(e,t,n){const{additionalAction:r,authToken:i,checkout:s,config:a,order:o,orderMeta:d,payment:c={},paymentMethod:u,paymentMethodMeta:l}=t,p=s&&s.consignments[0],m=p&&p.shippingAddress,g=p&&p.selectedShippingOption;return{additionalAction:r,authToken:i,paymentMethod:u&&this._transformPaymentMethod(u),customer:o&&o.billingAddress&&s&&Q(s.customer,o.billingAddress),billingAddress:o&&o.billingAddress&&U(o.billingAddress),shippingAddress:m&&s&&U(m,s.consignments),shippingOption:g&&ie(g,!0),cart:s&&G(s),order:o&&K(o,d),orderMeta:d,payment:this._transformHostedInputValues(e,c,n),quoteMeta:{request:Object.assign(Object.assign({},l),{geoCountryCode:a&&a.context.geoCountryCode})},source:"bigcommerce-checkout-js-sdk",store:a&&h(a.storeConfig.storeProfile,["storeHash","storeId","storeLanguage","storeName"])}}_transformPaymentMethod(e){return"multi-option"!==e.method||e.gateway?e.initializationData&&e.initializationData.gateway?Object.assign(Object.assign({},e),{id:e.initializationData.gateway}):e.id===$.BRAINTREE_VENMO?Object.assign(Object.assign({},e),{id:$.BRAINTREE_PAYPAL}):e:Object.assign(Object.assign({},e),{gateway:e.id})}_transformHostedInputValues(e,t,n){return"instrumentId"in t?Object.assign(Object.assign({},t),{ccCvv:e.cardCodeVerification,ccNumber:e.cardNumberVerification&&this._cardNumberFormatter.unformat(e.cardNumberVerification),hostedFormNonce:n}):Object.assign(Object.assign({},t),{ccCvv:e.cardCode,ccExpiry:this._cardExpiryFormatter.toObject(e.cardExpiry||""),ccName:e.cardName||"",ccNumber:this._cardNumberFormatter.unformat(e.cardNumber||""),hostedFormNonce:n})}_mapShippingAddress(e,t){var n,r,i,s;if(t){const a=null===(r=null===(n=t.initializationData)||void 0===n?void 0:n.bopis)||void 0===r?void 0:r.enabled,o=null===(s=null===(i=t.initializationData)||void 0===i?void 0:i.bopis)||void 0===s?void 0:s.requiredAddress,d=e.consignments.getConsignments(),c=null==d?void 0:d.every(e=>e.selectedPickupOption);if(a&&c&&"none"===o)return}return e.shippingAddress.getShippingAddress()}}var ae;class oe{constructor(e){this._requestSender=e}submitPaymentInstrument(e,t){return n=this,r=void 0,s=function*(){const{providerId:n,currencyCode:r,paymentsUrl:i,shopperId:s,storeHash:a,vaultToken:o}=e,{billingAddress:d,instrument:c,defaultInstrument:u}=t,l=`${i}/stores/${a}/customers/${s}/stored_instruments`,p={headers:{Authorization:o,Accept:"application/vnd.bc.v1+json","Content-Type":"application/vnd.bc.v1+json"},body:JSON.stringify({instrument:{type:c.type,cardholder_name:c.cardholderName,number:c.number,expiry_month:c.expiryMonth,expiry_year:c.expiryYear,verification_value:c.verificationValue},billing_address:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({email:d.email,address1:d.address1},d.address2&&{address2:d.address2}),{city:d.city,postal_code:d.postalCode,country_code:d.countryCode}),d.company&&{company:d.company}),{first_name:d.firstName,last_name:d.lastName}),d.phone&&{phone:d.phone}),d.stateOrProvinceCode&&{state_or_province_code:d.stateOrProvinceCode}),provider_id:n,default_instrument:u,currency_code:r})};yield this._requestSender.post(l,p)},new((i=void 0)||(i=Promise))(function(e,t){function a(e){try{d(s.next(e))}catch(e){t(e)}}function o(e){try{d(s.throw(e))}catch(e){t(e)}}function d(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i(function(e){e(n)})).then(a,o)}d((s=s.apply(n,r||[])).next())});var n,r,i,s}}!function(e){e.CardCode="cardCode",e.CardCodeVerification="cardCodeVerification",e.CardExpiry="cardExpiry",e.CardName="cardName",e.CardNumber="cardNumber",e.CardNumberVerification="cardNumberVerification"}(ae||(ae={}));const de=ae;function ce(e){switch(e){case de.CardCode:return"cc-csc";case de.CardExpiry:return"cc-exp";case de.CardName:return"cc-name";case de.CardNumber:return"cc-number";default:return""}}class ue{constructor(e,t,n){this._form=e,this._fieldTypes=t,this._inputAggregator=n,this._handleChange=e=>{const t=e.target;if(!t)throw new Error("Unable to get a reference to the target of the change event.");const n=this._inputAggregator.getInputs().find(e=>this._getAutocompleteElementId(e.getType())===t.id);n&&n.setValue(t.value)},this._inputs=this._fieldTypes.map(e=>this._createInput(e))}attach(){this._inputs.forEach(e=>this._form.appendChild(e))}detach(){this._inputs.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)})}_createInput(e){const t=document.createElement("input");return t.autocomplete=ce(e),t.id=this._getAutocompleteElementId(e),t.tabIndex=-1,t.style.position="absolute",t.style.opacity="0",t.style.zIndex="-1",t.addEventListener("change",this._handleChange),t}_getAutocompleteElementId(e){return`autocomplete-${u(e)}`}}var le,pe;!function(e){e.AttachRequested="HOSTED_FIELD:ATTACH_REQUESTED",e.SubmitRequested="HOSTED_FIELD:SUBMITTED_REQUESTED",e.ValidateRequested="HOSTED_FIELD:VALIDATE_REQUESTED",e.StoredCardRequested="HOSTED_FIELD:STORED_CARD_REQUESTED"}(le||(le={})),function(e){e.AttachSucceeded="HOSTED_INPUT:ATTACH_SUCCEEDED",e.AttachFailed="HOSTED_INPUT:ATTACH_FAILED",e.BinChanged="HOSTED_INPUT:BIN_CHANGED",e.Blurred="HOSTED_INPUT:BLURRED",e.Changed="HOSTED_INPUT:CHANGED",e.CardTypeChanged="HOSTED_INPUT:CARD_TYPE_CHANGED",e.Entered="HOSTED_INPUT:ENTERED",e.Focused="HOSTED_INPUT:FOCUSED",e.SubmitSucceeded="HOSTED_INPUT:SUBMIT_SUCCEEDED",e.SubmitFailed="HOSTED_INPUT:SUBMIT_FAILED",e.Validated="HOSTED_INPUT:VALIDATED",e.StoredCardSucceeded="HOSTED_INPUT:STORED_CARD_SUCCEEDED",e.StoredCardFailed="HOSTED_INPUT:STORED_CARD_FAILED"}(pe||(pe={}));class me{constructor(e,t,n,r,i,s,a,o,d,c,u,l,p){this._type=e,this._form=t,this._placeholder=n,this._accessibilityLabel=r,this._autocomplete=i,this._styles=s,this._fontUrls=a,this._eventListener=o,this._eventPoster=d,this._inputAggregator=c,this._inputValidator=u,this._paymentHandler=l,this._storedCardHandler=p,this._isTouched=!1,this._handleInput=e=>{const t=e.target;this._processChange(t.value)},this._handleBlur=()=>{this._applyStyles(this._styles.default),this._validateForm(),this._eventPoster.post({type:pe.Blurred,payload:{fieldType:this._type}})},this._handleFocus=()=>{this._applyStyles(this._styles.focus),this._eventPoster.post({type:pe.Focused,payload:{fieldType:this._type}})},this._handleValidate=()=>{this._validateForm()},this._handleSubmit=e=>{e.preventDefault(),this._eventPoster.post({type:pe.Entered,payload:{fieldType:this._type}})},this._forceFocusToInput=()=>{document.activeElement===document.body&&(navigator.userAgent.toLowerCase().indexOf("safari")>-1?""===this._input.value&&(this._input.setAttribute("value"," "),this._input.setSelectionRange(0,1),this._input.setAttribute("value","")):this._input.focus())},this._input=document.createElement("input"),this._input.addEventListener("input",this._handleInput),this._input.addEventListener("blur",this._handleBlur),this._input.addEventListener("focus",this._handleFocus),this._eventListener.addListener(le.ValidateRequested,this._handleValidate),this._eventListener.addListener(le.SubmitRequested,this._paymentHandler.handle),this._eventListener.addListener(le.StoredCardRequested,this._storedCardHandler.handle),this._configureInput()}getType(){return this._type}getValue(){return this._input.value}setValue(e){this._processChange(e)}isTouched(){return this._isTouched}attach(){this._form.appendChild(this._input),this._form.addEventListener("submit",this._handleSubmit),this._loadFonts(),this._eventPoster.setTarget(window.parent),this._eventListener.listen(),window.addEventListener("focus",this._forceFocusToInput),window.hostedInput=this,this._eventPoster.post({type:pe.AttachSucceeded})}detach(){this._input.parentElement&&this._input.parentElement.removeChild(this._input),this._form.removeEventListener("submit",this._handleSubmit),this._unloadFonts(),window.removeEventListener("focus",this._forceFocusToInput),this._eventListener.stopListen()}_formatValue(e){this._input.value=e}_notifyChange(e){this._eventPoster.post({type:pe.Changed,payload:{fieldType:this._type}})}_configureInput(){switch(this._input.style.backgroundColor="transparent",this._input.style.border="0",this._input.style.display="block",this._input.style.height="100%",this._input.style.margin="0",this._input.style.outline="none",this._input.style.padding="0",this._input.style.width="100%",this._input.id=u(this._type),this._input.placeholder=this._placeholder,this._input.autocomplete=this._autocomplete,this._input.setAttribute("aria-label",this._accessibilityLabel),this._applyStyles(this._styles.default),this._input.id){case"card-code":case"card-expiry":case"card-number":this._input.type="text",this._input.inputMode="numeric",this._input.pattern="[0-9]*";break;case"card-name":this._input.type="text",this._input.inputMode="text"}}_applyStyles(e={}){const t={color:e.color,fontFamily:e.fontFamily,fontSize:e.fontSize,fontWeight:e.fontWeight};Object.keys(t).forEach(e=>{t[e]&&(this._input.style[e]=t[e]||"")})}_loadFonts(){this._fontLinks||(this._fontLinks=this._fontUrls.filter(e=>"fonts.googleapis.com"===T(e).hostname).filter(e=>!document.querySelector(`link[href='${e}'][rel='stylesheet']`)).map(e=>{const t=document.createElement("link");return t.rel="stylesheet",t.href=e,document.head.appendChild(t),t}))}_unloadFonts(){this._fontLinks&&(this._fontLinks.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),this._fontLinks=void 0)}_validateForm(){return e=this,t=void 0,r=function*(){const e=this._inputAggregator.getInputValues(),t=yield this._inputValidator.validate(e);t.isValid?this._applyStyles(this._styles.default):this._applyStyles(this._styles.error),this._eventPoster.post({type:pe.Validated,payload:t})},new((n=void 0)||(n=Promise))(function(i,s){function a(e){try{d(r.next(e))}catch(e){s(e)}}function o(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}d((r=r.apply(e,t||[])).next())});var e,t,n,r}_processChange(e){e!==this._previousValue&&(this._isTouched=!0,this._formatValue(e),this._validateForm(),this._notifyChange(e),this._previousValue=e)}}class he extends me{constructor(e,t,n,r,i,s,a,o,d,c,u,l,p){super(de.CardExpiry,e,t,n,r,i,s,a,o,d,c,u,l),this._formatter=p}_formatValue(e){this._input.value=this._formatter.format(e)}}class ge extends me{constructor(e,t,n,r,i,s,a,o,d,c,u,l,p,m,h){super(e,t,n,r,i,s,a,o,d,c,u,l,p),this._autocompleteFieldset=m,this._formatter=h}attach(){super.attach(),this._autocompleteFieldset.attach()}_notifyChange(e){const t=E(e).card,n=this._previousValue&&E(this._previousValue).card;c(n,"type")!==c(t,"type")&&this._eventPoster.post({type:pe.CardTypeChanged,payload:{cardType:t?t.type:void 0}});const r=this._formatter.unformat(e),i=this._previousValue?this._formatter.unformat(this._previousValue):"",s=r.length>=6&&E(r).isPotentiallyValid?r.substr(0,6):"";s!==(i.length>=6?i.substr(0,6):"")&&this._eventPoster.post({type:pe.BinChanged,payload:{bin:s}})}_formatValue(e){const t=this._input.selectionEnd,n=this._formatter.format(e);t===e.length&&e.length<n.length?this._input.setSelectionRange(n.length,n.length):this._input.setSelectionRange(t||0,t||0),this._input.value=n}}class ye{constructor(e){this._parentWindow=e}getInputs(e){return Array.prototype.slice.call(this._parentWindow.frames).reduce((t,n)=>{try{const r=n.hostedInput;return!r||e&&!e(r)?t:[...t,r]}catch(e){if(e instanceof DOMException)return t;if(e instanceof Error&&"Permission denied"===e.message)return t;throw e}},[])}getInputValues(e){return this.getInputs(e).reduce((e,t)=>Object.assign(Object.assign({},e),{[t.getType()]:t.getValue()}),{})}}class _e extends w{constructor(e){super(["Unable to proceed due to invalid user input values",...d(f(e),e=>p(e,({message:e})=>e))].join(". ")),this.errors=e,this.name="InvalidHostedFormValueError",this.type="invalid_hosted_form_value"}}class fe{constructor(e,t,n,r,i,s){this._inputAggregator=e,this._inputValidator=t,this._inputStorage=n,this._eventPoster=r,this._paymentRequestSender=i,this._paymentRequestTransformer=s,this.handle=({payload:{data:e}})=>{return t=this,n=void 0,i=function*(){const t=this._inputAggregator.getInputValues(),n=yield this._inputValidator.validate(t);if(this._eventPoster.post({type:pe.Validated,payload:n}),!n.isValid){const e=new _e(n.errors);return this._eventPoster.post({type:pe.SubmitFailed,payload:{error:{code:y(e.name),message:e.message}}})}try{const n=yield this._paymentRequestSender.submitPayment(this._paymentRequestTransformer.transformWithHostedFormData(t,e,this._inputStorage.getNonce()||""));this._eventPoster.post({type:pe.SubmitSucceeded,payload:{response:n}})}catch(e){this._isPaymentErrorResponse(e)?this._eventPoster.post({type:pe.SubmitFailed,payload:{error:e.body.errors[0],response:e}}):this._isErrorResponse(e)&&this._eventPoster.post({type:pe.SubmitFailed,payload:{error:{code:y(e.name),message:e.message}}})}},new((r=void 0)||(r=Promise))(function(e,s){function a(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(a,o)}d((i=i.apply(t,n||[])).next())});var t,n,r,i}}_isPaymentErrorResponse(e){const{body:{errors:t=[]}={}}=e||{};return"string"==typeof(t[0]&&t[0].code)&&"string"==typeof(t[0]&&t[0].message)}_isErrorResponse(e){return"object"==typeof e&&null!==e&&("name"in e&&"string"==typeof e.name||!("name"in e))&&("message"in e&&"string"==typeof e.message||!("message"in e))}}class be{constructor(e,t,n,r){this._inputAggregator=e,this._inputValidator=t,this._eventPoster=n,this._storedCardRequestSender=r,this.handle=e=>{return t=this,n=void 0,i=function*(){var t;const{payload:{data:n,fields:r}}=e,i=this._inputAggregator.getInputValues(),s=yield this._inputValidator.validate(i);if(this._eventPoster.post({type:pe.Validated,payload:s}),!s.isValid)return this._eventPoster.post({type:pe.StoredCardFailed});const{defaultInstrument:a}=r,o=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(r,["defaultInstrument"]),[d,c]=i.cardExpiry?i.cardExpiry.split("/"):[];try{yield this._storedCardRequestSender.submitPaymentInstrument(n,{billingAddress:o,instrument:{type:"card",cardholderName:i.cardName||"",number:i.cardNumber?i.cardNumber.replace(/ /g,""):"",expiryMonth:Number(d.trim()),expiryYear:Number(`20${c.trim()}`),verificationValue:null!==(t=i.cardCode)&&void 0!==t?t:""},defaultInstrument:a}),this._eventPoster.post({type:pe.StoredCardSucceeded})}catch(e){this._eventPoster.post({type:pe.StoredCardFailed})}},new((r=void 0)||(r=Promise))(function(e,s){function a(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(a,o)}d((i=i.apply(t,n||[])).next())});var t,n,r,i}}}class Ce{constructor(e){this._cardInstrument=e,this._completeSchema={cardCode:this._getCardCodeSchema(),cardCodeVerification:this._getCardCodeVerificationSchema(),cardExpiry:this._getCardExpirySchema(),cardName:this._getCardNameSchema(),cardNumber:this._getCardNumberSchema(),cardNumberVerification:this._getCardNumberVerificationSchema()},this._configureCardValidator()}validate(e){return t=this,n=void 0,i=function*(){const t={},n={errors:{},isValid:!0};let r;for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=this._completeSchema[r],n.errors[r]=[]);try{return yield O(t).validate(e,{abortEarly:!1}),n}catch(e){if(this._isValidationErrorType(e))throw e;return{errors:Object.keys(n.errors).reduce((t,n)=>Object.assign(Object.assign({},t),{[n]:e.inner.filter(e=>e.path===n).map(e=>({fieldType:e.path,message:e.errors.join(" "),type:e.type}))}),{}),isValid:!1}}},new((r=void 0)||(r=Promise))(function(e,s){function a(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(a,o)}d((i=i.apply(t,n||[])).next())});var t,n,r,i}_configureCardValidator(){const e=b.getTypeInfo("discover"),t=b.getTypeInfo("jcb"),n=b.getTypeInfo("visa");b.updateCard("visa",{lengths:[13,...n.lengths||[]]}),b.updateCard("discover",{patterns:[...e.patterns||[],[810,817]]}),b.addCard({niceType:"Mada",type:"mada",patterns:[400861,401757,407197,407395,409201,410685,412565,417633,419593,422817,422818,422819,428331,428671,428672,428673,431361,432328,434107,439954,440533,440647,440795,445564,446393,446404,446672,455036,455708,457865,458456,462220,468540,468541,468542,468543,483010,483011,483012,484783,486094,486095,486096,489317,489318,489319,493428,504300,506968,508160,513213,520058,521076,524130,524514,529415,529741,530060,530906,531095,531196,532013,535825,535989,536023,537767,539931,543085,543357,549760,554180,557606,558848,585265,588845,588846,588847,588848,588849,588850,588851,588982,588983,589005,589206,604906,605141,636120,968201,968202,968203,968204,968205,968206,968207,968208,968209,968210,968211],gaps:[4,8,12],lengths:[16,18,19],code:{name:"CVV",size:3}}),b.updateCard("jcb",{patterns:[...t.patterns||[],3088,3337,3338]})}_getCardCodeSchema(){return I().required("CVV is required").test({message:"CVV must be valid",name:"invalid_card_code",test(e){const{card:t}=E(this.parent.cardNumber||"");return C(e,t&&t.code?t.code.size:void 0).isValid}})}_getCardCodeVerificationSchema(){return I().required("CVV is required").test({message:"CVV must be valid",name:"invalid_card_code",test:(e="")=>{const t=this._cardInstrument&&this._mapFromInstrumentCardType(this._cardInstrument.brand),n=t&&b.getTypeInfo(t);return C(e,n&&n.code?n.code.size:void 0).isValid}})}_getCardExpirySchema(){return I().required("Expiration date is required").test({message:"Expiration date must be a valid future date in MM / YY format",name:"invalid_card_expiry",test:e=>v(e).isValid})}_getCardNameSchema(){return I().max(200).required("Full name is required").test({message:"Credit card name must be valid",name:"invalid_card_name",test:e=>{const t=e.replace(/\s/g,"").match(/[0-9]+/g);if(!(null==t?void 0:t.length))return!0;for(const e of t)if(E(e).isValid)return!1;return!0}})}_getCardNumberSchema(){return I().required("Credit card number is required").test({message:"Credit card number must be valid",name:"invalid_card_number",test:e=>E(e).isValid})}_getCardNumberVerificationSchema(){return I().required("Credit card number is required").test({message:"Credit card number must be valid",name:"invalid_card_number",test:(e="")=>E(e).isValid}).test({message:"The card number entered does not match the card stored in your account",name:"mismatched_card_number",test:(e="")=>!!this._cardInstrument&&e.slice(-this._cardInstrument.last4.length)===this._cardInstrument.last4})}_mapFromInstrumentCardType(e){switch(e){case"amex":case"american_express":return"american-express";case"diners":return"diners-club";default:return e}}_isValidationErrorType(e){return"name"in e&&"ValidationError"!==e.name}}class ve{constructor(e){this._parentOrigin=e}create(e,t,n={},r=[],i="",s=function(e){switch(e){case de.CardCode:case de.CardCodeVerification:return"CVC";case de.CardExpiry:return"Expiration";case de.CardName:return"Name on card";case de.CardNumber:case de.CardNumberVerification:return"Credit card number"}}(t),a){const o=ce(t);return t===de.CardNumber?this._createNumberInput(t,e,n,r,i,s,o):t===de.CardNumberVerification?this._createNumberInput(t,e,n,r,i,s,o,a):t===de.CardExpiry?this._createExpiryInput(e,n,r,i,s,o):t===de.CardCodeVerification?this._createInput(t,e,n,r,i,s,o,a):this._createInput(t,e,n,r,i,s,o)}normalizeParentOrigin(e){this._parentOrigin!==e&&(this._parentOrigin!==S(T(e)).origin&&e!==S(T(this._parentOrigin)).origin||(this._parentOrigin=e))}getParentOrigin(){return this._parentOrigin}_createExpiryInput(e,t,n,r,i="",s=""){return new he(e,r,i,s,t,n,new N(this._parentOrigin),new L(this._parentOrigin,window.parent),new ye(window.parent),new Ce,this._createPaymentHandler(),this._createStoredCardHandler(),new Z)}_createNumberInput(e,t,n,r,i,s="",a="",o){return new ge(e,t,i,s,a,n,r,new N(this._parentOrigin),new L(this._parentOrigin,window.parent),new ye(window.parent),new Ce(o),this._createPaymentHandler(o),this._createStoredCardHandler(o),new ue(t,[de.CardCode,de.CardExpiry,de.CardName],new ye(window.parent)),new J)}_createInput(e,t,n,r,i,s="",a="",o){return new me(e,t,i,s,a,n,r,new N(this._parentOrigin),new L(this._parentOrigin,window.parent),new ye(window.parent),new Ce(o),this._createPaymentHandler(o),this._createStoredCardHandler(o))}_createPaymentHandler(t){return new fe(new ye(window.parent),new Ce(t),V(),new L(this._parentOrigin,window.parent),new R(e()),new se)}_createStoredCardHandler(e){return new be(new ye(window.parent),new Ce(e),new L(this._parentOrigin,window.parent),new oe(t()))}}class Ee extends w{constructor(e){super(e||"Unable to proceed due to invalid configuration provided for the hosted payment form."),this.name="InvalidHostedFormConfigError",this.type="invalid_hosted_form_config"}}class Oe{constructor(e,t,n){this._factory=e,this._storage=t,this._eventListener=n}initialize(e,t){t&&this._storage.setNonce(t);const r=this._createFormContainer(e);return this._resetPageStyles(e),this._eventListener.listen(),n(this._eventListener,le.AttachRequested).pipe(i(({payload:e})=>{const{accessibilityLabel:t,cardInstrument:n,fontUrls:i,placeholder:s,styles:a,origin:o,type:d}=e;o&&this._factory.normalizeParentOrigin(o);const c=this._factory.create(r,d,a,i,s,t,n);return c.attach(),c}),s(1)).toPromise()}_resetPageStyles(e){[document.querySelector("html"),document.querySelector("body"),document.getElementById(e)].forEach(e=>{e&&(e.style.height="100%",e.style.width="100%",e.style.overflow="hidden",e.style.padding="0",e.style.margin="0")})}_createFormContainer(e){const t=document.getElementById(e);if(!t)throw new Ee("Unable to proceed because the provided container ID is not valid.");const n=document.createElement("form"),r=document.createElement("button");return n.noValidate=!0,n.style.height="100%",n.style.width="100%",r.style.display="none",t.appendChild(n),n.appendChild(r),n}}function Ie(e){const{containerId:t,nonce:n,parentOrigin:r}=e;return new Oe(new ve(r),V(),new N(r)).initialize(t,n)}const Pe=new L("*",window.parent);function we(e){Pe.post({type:pe.AttachFailed,payload:{error:e}})}export{Ie as initializeHostedInput,we as notifyInitializeError};
//# sourceMappingURL=hosted-form.js.map