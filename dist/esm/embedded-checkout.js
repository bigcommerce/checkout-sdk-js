import*as e from"iframe-resizer";import*as t from"iframe-resizer/js/iframeResizer.contentWindow";import{createRequestSender as s}from"@bigcommerce/request-sender";import{fromEvent as o}from"rxjs";import{filter as r,map as n,take as i}from"rxjs/operators";import{default as a}from"local-storage-fallback";var c={785:t=>{t.exports=e},939:e=>{e.exports=t}},l={};function h(e){var t=l[e];if(void 0!==t)return t.exports;var s=l[e]={exports:{}};return c[e](s,s.exports,h),s.exports}h.d=(e,t)=>{for(var s in t)h.o(t,s)&&!h.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},h.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const d={size:70,color:"#d9d9d9",backgroundColor:"#ffffff"},p="embedded-checkout-loading-indicator-rotation";class m{constructor(e){this.styles=Object.assign(Object.assign({},d),e&&e.styles),this.containerStyles=Object.assign({},e&&e.containerStyles),this.defineAnimation(),this.container=this.buildContainer(),this.indicator=this.buildIndicator(),this.container.appendChild(this.indicator)}show(e){if(e){const t=document.getElementById(e);if(!t)throw new Error("Unable to attach the loading indicator because the parent ID is not valid.");t.appendChild(this.container)}this.container.style.visibility="visible",this.container.style.opacity="1"}hide(){const e=()=>{this.container.style.visibility="hidden",this.container.removeEventListener("transitionend",e)};this.container.addEventListener("transitionend",e),this.container.style.opacity="0"}buildContainer(){const e=document.createElement("div");return e.style.display="block",e.style.bottom="0",e.style.left="0",e.style.height="100%",e.style.width="100%",e.style.position="absolute",e.style.right="0",e.style.top="0",e.style.transition="all 250ms ease-out",e.style.opacity="0",this.setStyleAttribute(e,this.containerStyles),e}buildIndicator(){const e=document.createElement("div");return e.style.display="block",e.style.width=`${this.styles.size}px`,e.style.height=`${this.styles.size}px`,e.style.borderRadius=`${this.styles.size}px`,e.style.border="solid 1px",e.style.borderColor=`${this.styles.backgroundColor} ${this.styles.backgroundColor} ${this.styles.color} ${this.styles.color}`,e.style.margin="0 auto",e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.top="50%",e.style.transform="translateY(-50%) rotate(0deg)",e.style.transformStyle="preserve-3d",e.style.animation=`${p} 500ms infinite cubic-bezier(0.69, 0.31, 0.56, 0.83)`,e}setStyleAttribute(e,t){Object.keys(t).forEach(s=>{e.style.setProperty(s,t[s])})}defineAnimation(){var e;if(document.getElementById(p))return;const t=document.createElement("style");t.id=p,null===(e=document.head)||void 0===e||e.appendChild(t),t.sheet instanceof CSSStyleSheet&&t.sheet.insertRule(`\n                @keyframes ${p} {\n                    0% { transform: translateY(-50%) rotate(0deg); }\n                    100% { transform: translateY(-50%) rotate(360deg); }\n                }\n            `,0)}}const u=function(e,t,s){return t&&s?g(0,t,s):function(e){const t=class extends e{};return Object.getOwnPropertyNames(e.prototype).forEach(s=>{const o=Object.getOwnPropertyDescriptor(e.prototype,s);o&&"constructor"!==s&&Object.defineProperty(t.prototype,s,g(e.prototype,s,o))}),t}(e)};function g(e,t,s){if("function"!=typeof s.value)return s;let o=s.value;return{get(){const e=o.bind(this);return Object.defineProperty(this,t,Object.assign(Object.assign({},s),{value:e})),e},set(e){o=e}}}class y extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class f extends y{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}function _(e){if(!/^(https?:)?\/\//.test(e))throw new f("The provided URL must be absolute.");const t=document.createElement("a");t.href=e;const s=t.port&&-1!==e.indexOf(`${t.hostname}:${t.port}`)?t.port:"";return{hash:t.hash,hostname:t.hostname,href:t.href,origin:`${t.protocol}//${t.hostname}${s?`:${s}`:""}`,pathname:t.pathname,port:s,protocol:t.protocol,search:t.search}}function b(e){return _(0===e.hostname.indexOf("www")?e.href:e.href.replace(e.hostname,`www.${e.hostname}`))}function w(e,t){return e.type===t}var O;class E{constructor(e){this._sourceOrigins=[_(e).origin,b(_(e)).origin],this._isListening=!1,this._listeners={}}listen(){this._isListening||(this._isListening=!0,window.addEventListener("message",this._handleMessage))}stopListen(){this._isListening&&(this._isListening=!1,window.removeEventListener("message",this._handleMessage))}addListener(e,t){let s=this._listeners[e];s||(this._listeners[e]=s=[]),-1===s.indexOf(t)&&s.push(t)}removeListener(e,t){const s=this._listeners[e];if(!s)return;const o=s.indexOf(t);o>=0&&s.splice(o,1)}trigger(e,t){const s=this._listeners[e.type];s&&s.forEach(s=>t?s(e,t):s(e))}_handleMessage(e){if(-1===this._sourceOrigins.indexOf(e.origin)||!w(e.data,e.data.type))return;const t=e.data,{context:s}=t,o=function(e,t){var s={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(s[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(s[o[r]]=e[o[r]])}return s}(t,["context"]);this.trigger(o,s)}}!function(e,t,s,o){var r,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(n<3?r(i):n>3?r(t,s,i):r(t,s))||i);n>3&&i&&Object.defineProperty(t,s,i)}([u],E.prototype,"_handleMessage",null);class v{constructor(e,t,s){this._targetWindow=t,this._context=s,this._targetOrigin="*"===e?"*":_(e).origin}post(e,t){const s=this._targetWindow;if(window===s)return;if(!s)throw new Error("Unable to post message because target window is not set.");const a=t&&o(window,"message").pipe(r(e=>e.origin===this._targetOrigin&&w(e.data,e.data.type)&&-1!==[t.successType,t.errorType].indexOf(e.data.type)),n(e=>{if(t.errorType===e.data.type)throw e.data;return e.data}),i(1)).toPromise();return s.postMessage(Object.assign(Object.assign({},e),{context:this._context}),this._targetOrigin),a}setTarget(e){this._targetWindow=e}setContext(e){this._context=e}}class L{constructor(e){this._namespace=e}getItem(e){const t=a.getItem(this.withNamespace(e));if(null===t)return null;try{return JSON.parse(t)}catch(t){return this.removeItem(this.withNamespace(e)),null}}getItemOnce(e){const t=this.getItem(e);return this.removeItem(e),t}setItem(e,t){return a.setItem(this.withNamespace(e),JSON.stringify(t))}removeItem(e){return a.removeItem(this.withNamespace(e))}withNamespace(e){return`${this._namespace}.${e}`}}!function(e){e.CheckoutComplete="CHECKOUT_COMPLETE",e.CheckoutError="CHECKOUT_ERROR",e.CheckoutLoaded="CHECKOUT_LOADED",e.FrameError="FRAME_ERROR",e.FrameLoaded="FRAME_LOADED",e.SignedOut="SIGNED_OUT"}(O||(O={}));const C={body:{},headers:{},status:0};class k extends y{constructor(e,{message:t,errors:s}={}){const{body:o,headers:r,status:n}=e||C;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=o,this.headers=r,this.status=n,this.errors=s||[]}}class I extends k{constructor(e){super(e,{message:e.body.title}),this.name="InvalidLoginTokenError",this.type="invalid_login_token"}}var j,P;!function(e){e.MissingContainer="missing_container",e.MissingContent="missing_content",e.UnknownError="unknown_error"}(j||(j={}));class x extends y{constructor(e,t=j.UnknownError){super(e||"Unable to embed the checkout form."),this.subtype=t,this.name="NotEmbeddableError",this.type="not_embeddable"}}!function(e){e.StyleConfigured="STYLE_CONFIGURED"}(P||(P={}));const S="isCookieAllowed",R="lastAllowCookieAttempt";let M=class{constructor(e,t,s,o,r,n,i,a){this._iframeCreator=e,this._messageListener=t,this._messagePoster=s,this._loadingIndicator=o,this._requestSender=r,this._storage=n,this._location=i,this._options=a,this._isAttached=!1,this._options.onComplete&&this._messageListener.addListener(O.CheckoutComplete,this._options.onComplete),this._options.onError&&this._messageListener.addListener(O.CheckoutError,this._options.onError),this._options.onLoad&&this._messageListener.addListener(O.CheckoutLoaded,this._options.onLoad),this._options.onFrameLoad&&this._messageListener.addListener(O.FrameLoaded,this._options.onFrameLoad),this._options.onSignOut&&this._messageListener.addListener(O.SignedOut,this._options.onSignOut),this._messageListener.addListener(O.FrameLoaded,()=>this._configureStyles())}attach(){return this._isAttached?Promise.resolve(this):(this._isAttached=!0,this._messageListener.listen(),this._loadingIndicator.show(this._options.containerId),this._allowCookie().then(()=>this._attemptLogin()).then(e=>this._iframeCreator.createFrame(e,this._options.containerId)).then(e=>{this._iframe=e,this._configureStyles(),this._loadingIndicator.hide()}).catch(e=>(this._isAttached=!1,this._retryAllowCookie(e).catch(()=>{throw this._messageListener.trigger({type:O.FrameError,payload:e}),this._loadingIndicator.hide(),e}))).then(()=>this))}detach(){this._isAttached&&(this._isAttached=!1,this._messageListener.stopListen(),this._iframe&&this._iframe.parentNode&&(this._iframe.parentNode.removeChild(this._iframe),this._iframe.iFrameResizer.close()))}_configureStyles(){this._iframe&&this._iframe.contentWindow&&this._options.styles&&(this._messagePoster.setTarget(this._iframe.contentWindow),this._messagePoster.post({type:P.StyleConfigured,payload:this._options.styles}))}_attemptLogin(){return/^\/login\/token/.test(_(this._options.url).pathname)?this._requestSender.post(this._options.url).then(({body:{redirectUrl:e}})=>e).catch(e=>Promise.reject(new I(e))):Promise.resolve(this._options.url)}_allowCookie(){if(this._storage.getItem(S))return Promise.resolve();this._storage.setItem(S,!0),this._storage.setItem(R,Date.now());const{origin:e}=_(this._options.url),t=`${e}/embedded-checkout/allow-cookie?returnUrl=${encodeURIComponent(this._location.href)}`;return document.body.style.visibility="hidden",this._location.replace(t),new Promise(()=>{})}_retryAllowCookie(e){const t=Number(this._storage.getItem(R));return(!t||Date.now()-t>6e5)&&e instanceof x&&e.subtype===j.MissingContent?(this._storage.removeItem(R),this._storage.removeItem(S),this._allowCookie()):Promise.reject()}};M=function(e,t,s,o){var r,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(n<3?r(i):n>3?r(t,s,i):r(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i}([u],M);const A=M;class F{constructor(e){this._options=e}createFrame(e,t){const s=document.getElementById(t),{timeout:o=6e4}=this._options||{};if(!s)throw new x("Unable to embed the iframe because the container element could not be found.",j.MissingContainer);const r=document.createElement("iframe");return r.src=e,r.style.border="none",r.style.display="none",r.style.width="100%",r.allowPaymentRequest=!0,r.allow="payment",s.appendChild(r),this._toResizableFrame(r,o).catch(e=>{throw s.removeChild(r),e})}_toResizableFrame(e,t){return new Promise((s,o)=>{const r=window.setTimeout(()=>{o(new x("Unable to embed the iframe because the content could not be loaded."))},t),n=t=>{if((t.origin===_(e.src).origin||t.origin===b(_(e.src)).origin)&&(w(t.data,O.FrameError)&&(i(),o(new x(t.data.payload.message,j.MissingContent))),w(t.data,O.FrameLoaded))){e.style.display="";const o=function(e,t){const{iframeResizer:s}=h(785);return s(e,t)}({scrolling:!1,sizeWidth:!1,heightCalculationMethod:t.data.payload&&t.data.payload.contentId?"taggedElement":"lowestElement"},e);i(),s(o[o.length-1])}},i=()=>{window.removeEventListener("message",n),window.clearTimeout(r)};window.addEventListener("message",n)})}}function $(e){const t=_(e.url).origin;return new A(new F,new E(t),new v(t),new m({styles:e.styles&&e.styles.loadingIndicator}),s(),new L("BigCommerce.EmbeddedCheckout"),window.location,e).attach()}function T(e){if(!e.payload||!e.payload.contentId)return;const t=document.getElementById(e.payload.contentId);t&&!t.hasAttribute("data-iframe-height")&&t.setAttribute("data-iframe-height","")}function U(e){return"object"==typeof e&&null!==e&&"message"in e&&"type"in e}let D=class{constructor(e,t,s,o={}){this._messageListener=e,this._messagePoster=t,this._untargetedMessagePoster=s,this._messageHandlers=o,this._messageListener.listen()}postComplete(){const e={type:O.CheckoutComplete};this._postMessage(e)}postError(e){const t={type:O.CheckoutError,payload:this._transformError(e)};this._postMessage(t)}postFrameError(e){const t={type:O.FrameError,payload:this._transformError(e)};this._postMessage(t,{untargeted:!0})}postFrameLoaded(e){const t={type:O.FrameLoaded,payload:e};this._postMessage(t)}postLoaded(){const e={type:O.CheckoutLoaded};this._postMessage(e)}postSignedOut(){const e={type:O.SignedOut};this._postMessage(e)}receiveStyles(e){this._messageListener.addListener(P.StyleConfigured,({payload:t})=>{e(t)})}_postMessage(e,t){if(this._notifyMessageHandlers(e),t&&t.untargeted)return this._untargetedMessagePoster.post(e);this._messagePoster.post(e)}_notifyMessageHandlers(e){Object.keys(this._messageHandlers).forEach(t=>{if(e.type!==t)return;const s=this._messageHandlers[t];s&&s.call(null,e)})}_transformError(e){return{message:e.message,type:U(e)?e.type:void 0,subtype:U(e)?e.subtype:void 0}}};D=function(e,t,s,o){var r,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(n<3?r(i):n>3?r(t,s,i):r(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i}([u],D);const N=D;let z=class{postComplete(){}postError(){}postFrameError(){}postFrameLoaded(){}postLoaded(){}postSignedOut(){}receiveStyles(){}};z=function(e,t,s,o){var r,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(n<3?r(i):n>3?r(t,s,i):r(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i}([u],z);const H=z;function W(e){h(939);const t=e.parentWindow||window.parent;return window===t?new H:new N(new E(e.parentOrigin),new v(e.parentOrigin,t),new v("*",t),{[O.FrameLoaded]:T})}export{W as createEmbeddedCheckoutMessenger,$ as embedCheckout};
//# sourceMappingURL=embedded-checkout.js.map