import{flatMap as e,map as t,noop as r,pick as i,values as n,without as s}from"lodash";import{fromEvent as o}from"rxjs";import{filter as a,map as d,switchMap as c,take as h}from"rxjs/operators";class u{constructor(e){const t=new Promise((e,t)=>{this.cancel=t});this.promise=Promise.race([e,t])}}class l extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class p extends l{constructor(e){super(e||"Unable to proceed because the required element is unexpectedly detached from the page."),this.name="UnexpectedDetachmentError",this.type="unexpected_detachment"}}class m{constructor(e){this._mutationObserver=e}ensurePresence(e,t){return r=this,i=void 0,s=function*(){const r=new u(t),i=this._mutationObserver.create(t=>{t.forEach(t=>{0!==Array.from(t.removedNodes).filter(t=>e.some(e=>t===e||t.contains(e))).length&&r.cancel(new p)})});i.observe(document.body,{childList:!0,subtree:!0});try{const e=yield r.promise;return i.disconnect(),e}catch(e){throw i.disconnect(),e}},new((n=void 0)||(n=Promise))(function(e,t){function o(e){try{d(s.next(e))}catch(e){t(e)}}function a(e){try{d(s.throw(e))}catch(e){t(e)}}function d(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n(function(e){e(r)})).then(o,a)}d((s=s.apply(r,i||[])).next())});var r,i,n,s}}class f{constructor(e=window){this._window=e}create(e){return new this._window.MutationObserver(e)}}class _ extends l{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}function y(e){if(!/^(https?:)?\/\//.test(e))throw new _("The provided URL must be absolute.");const t=document.createElement("a");t.href=e;const r=t.port&&-1!==e.indexOf(`${t.hostname}:${t.port}`)?t.port:"";return{hash:t.hash,hostname:t.hostname,href:t.href,origin:`${t.protocol}//${t.hostname}${r?`:${r}`:""}`,pathname:t.pathname,port:r,protocol:t.protocol,search:t.search}}function v(e,t){return e.type===t}class E{constructor(e,t,r){this._targetWindow=t,this._context=r,this._targetOrigin="*"===e?"*":y(e).origin}post(e,t){const r=this._targetWindow;if(window===r)return;if(!r)throw new Error("Unable to post message because target window is not set.");const i=t&&o(window,"message").pipe(a(e=>e.origin===this._targetOrigin&&v(e.data,e.data.type)&&-1!==[t.successType,t.errorType].indexOf(e.data.type)),d(e=>{if(t.errorType===e.data.type)throw e.data;return e.data}),h(1)).toPromise();return r.postMessage(Object.assign(Object.assign({},e),{context:this._context}),this._targetOrigin),i}setTarget(e){this._targetWindow=e}setContext(e){this._context=e}}function b(e,t,r){if("function"!=typeof r.value)return r;let i=r.value;return{get(){const e=i.bind(this);return Object.defineProperty(this,t,Object.assign(Object.assign({},r),{value:e})),e},set(e){i=e}}}class g{constructor(e){var t;this._sourceOrigins=[y(e).origin,(t=y(e),y(0===t.hostname.indexOf("www")?t.href:t.href.replace(t.hostname,`www.${t.hostname}`))).origin],this._isListening=!1,this._listeners={}}listen(){this._isListening||(this._isListening=!0,window.addEventListener("message",this._handleMessage))}stopListen(){this._isListening&&(this._isListening=!1,window.removeEventListener("message",this._handleMessage))}addListener(e,t){let r=this._listeners[e];r||(this._listeners[e]=r=[]),-1===r.indexOf(t)&&r.push(t)}removeListener(e,t){const r=this._listeners[e];if(!r)return;const i=r.indexOf(t);i>=0&&r.splice(i,1)}trigger(e,t){const r=this._listeners[e.type];r&&r.forEach(r=>t?r(e,t):r(e))}_handleMessage(e){if(-1===this._sourceOrigins.indexOf(e.origin)||!v(e.data,e.data.type))return;const t=e.data,{context:r}=t,i=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(r[i[n]]=e[i[n]])}return r}(t,["context"]);this.trigger(i,r)}}!function(e,t,r,i){var n,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(s<3?n(o):s>3?n(t,r,o):n(t,r))||o);s>3&&o&&Object.defineProperty(t,r,o)}([function(e,t,r){return t&&r?b(0,t,r):function(e){const t=class extends e{};return Object.getOwnPropertyNames(e.prototype).forEach(r=>{const i=Object.getOwnPropertyDescriptor(e.prototype,r);i&&"constructor"!==r&&Object.defineProperty(t.prototype,r,b(e.prototype,r,i))}),t}(e)}],g.prototype,"_handleMessage",null);const w={body:{},headers:{},status:0};class O extends l{constructor(e,{message:t,errors:r}={}){const{body:i,headers:n,status:s}=e||w;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=i,this.headers=n,this.status=s,this.errors=r||[]}}function S(e){if(Array.isArray(e))return e.reduce((e,t)=>t&&t.message?[...e,t.message]:e,[]).join(" ")}class T extends l{constructor(e){super(e||"Unable to proceed due to invalid configuration provided for the hosted payment form."),this.name="InvalidHostedFormConfigError",this.type="invalid_hosted_form_config"}}class F extends l{constructor(e){super(e||"Unable to proceed due to an unknown error with the hosted payment form."),this.name="InvalidHostedFormError",this.type="invalid_hosted_form"}}class D extends l{constructor(r){super(["Unable to proceed due to invalid user input values",...e(n(r),e=>t(e,({message:e})=>e))].join(". ")),this.errors=r,this.name="InvalidHostedFormValueError",this.type="invalid_hosted_form_value"}}var I,P;!function(e){e.AttachRequested="HOSTED_FIELD:ATTACH_REQUESTED",e.SubmitRequested="HOSTED_FIELD:SUBMITTED_REQUESTED",e.SubmitManualOrderRequested="HOSTED_FIELD:SUBMIT_MANUAL_ORDER_REQUESTED",e.ValidateRequested="HOSTED_FIELD:VALIDATE_REQUESTED",e.StoredCardRequested="HOSTED_FIELD:STORED_CARD_REQUESTED"}(I||(I={})),function(e){e.AttachSucceeded="HOSTED_INPUT:ATTACH_SUCCEEDED",e.AttachFailed="HOSTED_INPUT:ATTACH_FAILED",e.BinChanged="HOSTED_INPUT:BIN_CHANGED",e.Blurred="HOSTED_INPUT:BLURRED",e.Changed="HOSTED_INPUT:CHANGED",e.CardTypeChanged="HOSTED_INPUT:CARD_TYPE_CHANGED",e.Entered="HOSTED_INPUT:ENTERED",e.Focused="HOSTED_INPUT:FOCUSED",e.SubmitSucceeded="HOSTED_INPUT:SUBMIT_SUCCEEDED",e.SubmitFailed="HOSTED_INPUT:SUBMIT_FAILED",e.SubmitManualOrderSucceeded="HOSTED_INPUT:SUBMIT_MANUAL_ORDER_SUCCEEDED",e.SubmitManualOrderFailed="HOSTED_INPUT:SUBMIT_MANUAL_ORDER_FAILED",e.Validated="HOSTED_INPUT:VALIDATED",e.StoredCardSucceeded="HOSTED_INPUT:STORED_CARD_SUCCEEDED",e.StoredCardFailed="HOSTED_INPUT:STORED_CARD_FAILED"}(P||(P={}));var C=function(e,t,r,i){return new(r||(r=Promise))(function(n,s){function o(e){try{d(i.next(e))}catch(e){s(e)}}function a(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,a)}d((i=i.apply(e,t||[])).next())})};class L{constructor(e,t,r,i,n,s,o,a,d){this._type=e,this._containerId=t,this._placeholder=r,this._accessibilityLabel=i,this._styles=n,this._eventPoster=s,this._eventListener=o,this._detachmentObserver=a,this._orderId=d,this._iframe=document.createElement("iframe"),this._iframe.src=this.getFrameSrc(this._orderId),this._iframe.style.border="none",this._iframe.style.height="100%",this._iframe.style.overflow="hidden",this._iframe.style.width="100%"}getFrameSrc(e){return void 0!==e?`/admin/payments/${this._orderId}/hosted-form-field?version=1.819.0`:"/account/stored-instruments/hosted-fields?version=1.819.0"}getType(){return this._type}attach(){return C(this,void 0,void 0,function*(){const e=document.getElementById(this._containerId);if(!e)throw new T("Unable to proceed because the provided container ID is not valid.");e.appendChild(this._iframe),this._eventListener.listen();const t=o(this._iframe,"load").pipe(c(({target:e})=>C(this,void 0,void 0,function*(){const t=e&&e.contentWindow;if(!t)throw new Error("The content window of the iframe cannot be accessed.");this._eventPoster.setTarget(t),yield this._eventPoster.post({type:I.AttachRequested,payload:{accessibilityLabel:this._accessibilityLabel,fontUrls:this._getFontUrls(),placeholder:this._placeholder,styles:this._styles,origin:document.location.origin,type:this._type}},{successType:P.AttachSucceeded,errorType:P.AttachFailed})})),h(1)).toPromise();yield this._detachmentObserver.ensurePresence([this._iframe],t)})}detach(){this._iframe.parentElement&&(this._iframe.parentElement.removeChild(this._iframe),this._eventListener.stopListen())}submitForm(e,t){return C(this,void 0,void 0,function*(){try{const r=this._eventPoster.post({type:I.SubmitRequested,payload:{fields:e,data:t}},{successType:P.SubmitSucceeded,errorType:P.SubmitFailed});return yield this._detachmentObserver.ensurePresence([this._iframe],r)}catch(e){if(this._isSubmitErrorEvent(e)){if("hosted_form_error"===e.payload.error.code)throw new F(e.payload.error.message);if(e.payload.response)throw function(e){const{body:t}=e,{errors:r=[]}=t;return new O(e,{message:S(r)||void 0,errors:r})}(e.payload.response);throw new Error(e.payload.error.message)}throw e}})}submitManualOrderForm(e){return C(this,void 0,void 0,function*(){try{const t=this._eventPoster.post({type:I.SubmitManualOrderRequested,payload:{data:e}},{successType:P.SubmitManualOrderSucceeded,errorType:P.SubmitManualOrderFailed});return yield this._detachmentObserver.ensurePresence([this._iframe],t)}catch(e){if(this._isSubmitManualOrderErrorEvent(e)){if("hosted_form_error"===e.payload.error.code)throw new F(e.payload.error.message);if(e.payload.error.message)throw new Error(e.payload.error.message);throw new Error(e.payload.error.code)}throw e}})}submitStoredCardForm(e,t){return C(this,void 0,void 0,function*(){const r=this._eventPoster.post({type:I.StoredCardRequested,payload:{fields:e,data:t}},{successType:P.StoredCardSucceeded,errorType:P.StoredCardFailed});return this._detachmentObserver.ensurePresence([this._iframe],r)})}validateForm(){return C(this,void 0,void 0,function*(){const e=this._eventPoster.post({type:I.ValidateRequested},{successType:P.Validated}),{payload:t}=yield this._detachmentObserver.ensurePresence([this._iframe],e);if(!t.isValid)throw new D(t.errors)})}_getFontUrls(){const e="fonts.googleapis.com",t=document.querySelectorAll(`link[href*='${e}'][rel='stylesheet']`);return Array.prototype.slice.call(t).filter(t=>y(t.href).hostname===e).filter(e=>n(this._styles).map(e=>e&&e.fontFamily).filter(e=>"string"==typeof e).some(t=>t.split(/,\s/).some(t=>-1!==e.href.indexOf(t.replace(" ","+"))))).map(e=>e.href)}_isSubmitManualOrderErrorEvent(e){return e instanceof Object&&null!==e&&"type"in e&&e.type===P.SubmitManualOrderFailed}_isSubmitErrorEvent(e){return e.type===P.SubmitFailed}}var U,x=function(e,t,r,i){return new(r||(r=Promise))(function(n,s){function o(e){try{d(i.next(e))}catch(e){s(e)}}function a(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,a)}d((i=i.apply(e,t||[])).next())})};class N{constructor(e,t,i){this._fields=e,this._eventListener=t,this._eventCallbacks=i,this._handleEnter=({payload:e})=>x(this,void 0,void 0,function*(){try{yield this.validate()}catch(e){if(e instanceof Error&&"InvalidHostedFormValueError"!==e.name)throw e}const{onEnter:t=r}=this._eventCallbacks;t(e)});const{onBlur:n=r,onCardTypeChange:s=r,onFocus:o=r,onValidate:a=r}=this._eventCallbacks;this._eventListener.addListener(P.Blurred,({payload:e})=>n(e)),this._eventListener.addListener(P.CardTypeChanged,({payload:e})=>s(e)),this._eventListener.addListener(P.Focused,({payload:e})=>o(e)),this._eventListener.addListener(P.Validated,({payload:e})=>a(e)),this._eventListener.addListener(P.Entered,this._handleEnter),this._eventListener.addListener(P.CardTypeChanged,({payload:e})=>this._cardType=e.cardType),this._eventListener.addListener(P.BinChanged,({payload:e})=>this._bin=e.bin)}getBin(){return this._bin}getCardType(){return this._cardType}attach(){return x(this,void 0,void 0,function*(){this._eventListener.listen();const e=this._getFirstField(),t=s(this._fields,e);yield e.attach(),yield Promise.all(t.map(e=>e.attach()))})}detach(){this._eventListener.stopListen(),this._fields.forEach(e=>{e.detach()})}submitManualOrderPayment(e){return x(this,void 0,void 0,function*(){return this._getFirstField().submitManualOrderForm(e.data)})}submitStoredCard(e){return x(this,void 0,void 0,function*(){return this._getFirstField().submitStoredCardForm(e.fields,e.data)})}submit(e,t,r,i){return x(this,void 0,void 0,function*(){try{return yield this._getFirstField().submitForm(this._fields.map(e=>e.getType()),r.transform(e,i))}catch(i){let n;if(!(i instanceof Error||"string"==typeof i))throw new Error("Unexpected error type");return n=yield t.handlePaymentHumanVerification(i),yield this._getFirstField().submitForm(this._fields.map(e=>e.getType()),r.transform(e,n))}})}validate(){return x(this,void 0,void 0,function*(){return this._getFirstField().validateForm()})}_getFirstField(){const e=this._fields[0];if(!e)throw new T("Unable to proceed because the payment form has no field defined.");return e}}class A{create(e,t){const r=Object.keys(t.fields).reduce((r,i)=>{const n=t.fields[i];return n?[...r,new L(i,n.containerId,n.placeholder||"",n.accessibilityLabel||"",t.styles||{},new E(e),new g(e),new m(new f),t.orderId)]:r},[]);return new N(r,new g(e),i(t,"onBlur","onEnter","onFocus","onCardTypeChange","onValidate"))}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(U||(U={}));class R extends l{constructor(e){super(function(e){switch(e){case U.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case U.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case U.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case U.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}class H{constructor(e,t){this._host=e,this._hostedFormFactory=t}initialize(e){const t=this._hostedFormFactory.create(this._host,e);return t.attach().then(()=>{this._hostedForm=t})}deinitialize(){this._hostedForm&&(this._hostedForm.detach(),this._hostedForm=void 0)}submitManualOrderPayment(e){return t=this,r=void 0,n=function*(){const t=this._hostedForm;if(!t)throw new R(U.PaymentNotInitialized);return yield t.validate(),t.submitManualOrderPayment({data:e})},new((i=void 0)||(i=Promise))(function(e,s){function o(e){try{d(n.next(e))}catch(e){s(e)}}function a(e){try{d(n.throw(e))}catch(e){s(e)}}function d(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i(function(e){e(r)})).then(o,a)}d((n=n.apply(t,r||[])).next())});var t,r,i,n}}function M(e){return new H(e,new A)}class z{constructor(e,t){this._host=e,this._hostedFormFactory=t}submitStoredCard(e,t){return r=this,i=void 0,s=function*(){const r=this._hostedForm;if(!r)throw new R(U.PaymentNotInitialized);yield r.validate().then(()=>r.submitStoredCard({fields:e,data:t}))},new((n=void 0)||(n=Promise))(function(e,t){function o(e){try{d(s.next(e))}catch(e){t(e)}}function a(e){try{d(s.throw(e))}catch(e){t(e)}}function d(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n(function(e){e(r)})).then(o,a)}d((s=s.apply(r,i||[])).next())});var r,i,n,s}initialize(e){const t=this._hostedFormFactory.create(this._host,e);return t.attach().then(()=>{this._hostedForm=t})}deinitialize(){this._hostedForm&&this._hostedForm.detach()}}function j(e){return new z(e,new A)}export{M as createHostedFormService,j as createStoredCardHostedFormService};
//# sourceMappingURL=hosted-form-v2-iframe-host.js.map